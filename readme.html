<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.25.5">
    <meta name="project" content="Noizu.AdvancedScaffolding v1.2.23">

    <title>Noizu.AdvancedScaffolding — Noizu.AdvancedScaffolding v1.2.23</title>
    <link rel="stylesheet" href="dist/elixir-d1506dba1db7cdc5483e.css" />

    <script src="dist/sidebar_items-3d772270ac.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/app-7b632b26f13d5e0d20e1.js"></script>


  </head>
  <body data-type="extras">
    <script>

      try {
        if (localStorage.getItem('night-mode') === 'true') {
          document.body.classList.add('night-mode');
        }
      } catch (error) { }
    </script>

<div class="main">

<button class="sidebar-button sidebar-toggle">
  <span class="icon-menu" title="Collapse/expand sidebar"></span>
</button>

<section class="sidebar">
  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <span class="icon-search" aria-hidden="true" title="Submit search"></span>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <span class="icon-cross" aria-hidden="true" title="Cancel search"></span>
    </button>
    <label class="search-label">
      <input name="q" type="text" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">
    <div class="sidebar-projectDetails">
      <a href="readme.html" class="sidebar-projectName">
Noizu.AdvancedScaffolding
      </a>
      <strong class="sidebar-projectVersion">
        v1.2.23
      </strong>
    </div>

  </div>

  <ul class="sidebar-listNav">
    <li><a id="extras-list-link" href="#full-list">Pages</a></li>

      <li><a id="modules-list-link" href="#full-list">Modules</a></li>


  </ul>
  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1 id="content">
Noizu.AdvancedScaffolding <a href="https://dl.circleci.com/status-badge/redirect/gh/noizu-labs/advanced_elixir_scaffolding/tree/master"><img src="https://dl.circleci.com/status-badge/img/gh/noizu-labs/advanced_elixir_scaffolding/tree/master.svg?style=svg" alt="CircleCI"/></a>

    <a href="https://github.com/noizu-lab/advanced_elixir_scaffolding/blob/master/README.md#L1" title="View Source" class="view-source" rel="help">
      <span class="icon-code" aria-hidden="true"></span>
      <span class="sr-only">View Source</span>
    </a>

</h1>

<p>This library provides some general tools to reduce some boiler plate code around working with objects, performing CRUD, auditing changes, performing basic authorization checks, and working with entity references (foreign keys). It includes various concepts previously applied to some of our private projects including blade of eternity, lacrosse alerts, and solace club.</p><h2 id="additional-documentation" class="section-heading">
  <a href="#additional-documentation" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Additional Documentation
</h2>
<ul><li><a href="http://noizu-labs.github.io/advanced_elixir_scaffolding">Api Documentation</a></li></ul><h1>New Features</h1><p>Advanced Scaffolding / Annotation / Indexing / Telemetry / Json Formatting / Security / PII management.</p><h2 id="see" class="section-heading">
  <a href="#see" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  See
</h2>
<ul><li><code class="inline">Noizu.AdvancedScaffolding.Internal.Core.Entity.Behaviour</code></li><li><code class="inline">Noizu.AdvancedScaffolding.Internal.Persistence.Entity.Behaviour</code></li><li><code class="inline">Noizu.AdvancedScaffolding.Internal.EntityIndex.Entity.Behaviour</code></li><li><code class="inline">Noizu.AdvancedScaffolding.Internal.Index.Behaviour</code></li><li><code class="inline">Noizu.AdvancedScaffolding.Internal.Json.Entity.Behaviour</code></li></ul><h1>Json Formatting Annotation</h1><ul><li>Support for multiple json formatting view (mobile, admin, etc.)</li></ul><pre><code class="makeup elixir"><span class="w">
</span><span class="na">@json_format_group</span><span class="w"> </span><span class="p" data-group-id="4607061346-1">{</span><span class="ss">:user_clients</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4607061346-2">[</span><span class="ss">:compact</span><span class="p" data-group-id="4607061346-2">]</span><span class="p" data-group-id="4607061346-1">}</span><span class="w">
</span><span class="na">@json_provider</span><span class="w"> </span><span class="k">unquote</span><span class="p" data-group-id="4607061346-3">(</span><span class="n">json_provider</span><span class="p" data-group-id="4607061346-3">)</span><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Entity</span><span class="w"> </span><span class="k" data-group-id="4607061346-4">do</span><span class="w">
  </span><span class="nc">Noizu.DomainObject</span><span class="o">.</span><span class="n">noizu_entity</span><span class="w"> </span><span class="k" data-group-id="4607061346-5">do</span><span class="w">
    </span><span class="na">@meta</span><span class="w"> </span><span class="p" data-group-id="4607061346-6">{</span><span class="ss">:enum_entity</span><span class="p">,</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="4607061346-6">}</span><span class="w">
    </span><span class="n">identifier</span><span class="w"> </span><span class="ss">:integer</span><span class="w">
    </span><span class="na">@json</span><span class="w"> </span><span class="p" data-group-id="4607061346-7">{</span><span class="ss">:*</span><span class="p">,</span><span class="w"> </span><span class="ss">:expand</span><span class="p" data-group-id="4607061346-7">}</span><span class="w">
    </span><span class="na">@json_embed</span><span class="w"> </span><span class="p" data-group-id="4607061346-8">{</span><span class="ss">:user_clients</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4607061346-9">[</span><span class="p" data-group-id="4607061346-10">{</span><span class="ss">:title</span><span class="p">,</span><span class="w"> </span><span class="ss">as</span><span class="p">:</span><span class="w"> </span><span class="ss">:name</span><span class="p" data-group-id="4607061346-10">}</span><span class="p" data-group-id="4607061346-9">]</span><span class="p" data-group-id="4607061346-8">}</span><span class="w">
    </span><span class="na">@json_embed</span><span class="w"> </span><span class="p" data-group-id="4607061346-11">{</span><span class="ss">:verbose_mobile</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4607061346-12">[</span><span class="p" data-group-id="4607061346-13">{</span><span class="ss">:title</span><span class="p">,</span><span class="w"> </span><span class="ss">as</span><span class="p">:</span><span class="w"> </span><span class="ss">:name</span><span class="p" data-group-id="4607061346-13">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4607061346-14">{</span><span class="ss">:body</span><span class="p">,</span><span class="w"> </span><span class="ss">as</span><span class="p">:</span><span class="w"> </span><span class="ss">:description</span><span class="p" data-group-id="4607061346-14">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4607061346-15">{</span><span class="ss">:editor</span><span class="p">,</span><span class="w"> </span><span class="ss">sref</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="4607061346-15">}</span><span class="p">,</span><span class="w"> </span><span class="ss">:revision</span><span class="p" data-group-id="4607061346-12">]</span><span class="p" data-group-id="4607061346-11">}</span><span class="w">
    </span><span class="n">public_field</span><span class="w"> </span><span class="ss">:description</span><span class="p">,</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="nc">Noizu.VersionedString.Type</span><span class="w">

    </span><span class="na">@json</span><span class="w"> </span><span class="p" data-group-id="4607061346-16">{</span><span class="ss">:*</span><span class="p">,</span><span class="w"> </span><span class="ss">format</span><span class="p">:</span><span class="w"> </span><span class="ss">:iso8601</span><span class="p" data-group-id="4607061346-16">}</span><span class="w">
    </span><span class="na">@json_ignore</span><span class="w"> </span><span class="ss">:user_clients</span><span class="w">
    </span><span class="n">public_field</span><span class="w"> </span><span class="ss">:created_on</span><span class="p">,</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="nc">Noizu.DateTime.Type</span><span class="w">

    </span><span class="na">@json</span><span class="w"> </span><span class="p" data-group-id="4607061346-17">{</span><span class="ss">:*</span><span class="p">,</span><span class="w"> </span><span class="ss">format</span><span class="p">:</span><span class="w"> </span><span class="ss">:iso8601</span><span class="p" data-group-id="4607061346-17">}</span><span class="w">
    </span><span class="na">@json_ignore</span><span class="w"> </span><span class="p" data-group-id="4607061346-18">[</span><span class="ss">:user_clients</span><span class="p" data-group-id="4607061346-18">]</span><span class="w">
    </span><span class="n">public_field</span><span class="w"> </span><span class="ss">:modified_on</span><span class="p">,</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="nc">Noizu.DateTime.Type</span><span class="w">

    </span><span class="na">@json</span><span class="w"> </span><span class="p" data-group-id="4607061346-19">{</span><span class="ss">:*</span><span class="p">,</span><span class="w"> </span><span class="ss">format</span><span class="p">:</span><span class="w"> </span><span class="ss">:iso8601</span><span class="p" data-group-id="4607061346-19">}</span><span class="w">
    </span><span class="na">@json_ignore</span><span class="w"> </span><span class="p" data-group-id="4607061346-20">[</span><span class="ss">:user_clients</span><span class="p">,</span><span class="w"> </span><span class="ss">:verbose_mobile</span><span class="p" data-group-id="4607061346-20">]</span><span class="w">
    </span><span class="n">public_field</span><span class="w"> </span><span class="ss">:deleted_on</span><span class="p">,</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="nc">Noizu.DateTime.Type</span><span class="w">
  </span><span class="k" data-group-id="4607061346-5">end</span><span class="w">
</span><span class="k" data-group-id="4607061346-4">end</span><span class="w">
</span></code></pre><ul><li>Support for embedding nested components inside of entity. E.g. pull CMS record details and return inline as port of entity instead of as nested objects.</li></ul><pre><code class="makeup elixir"><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Entity</span><span class="w"> </span><span class="k" data-group-id="9853891005-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Noizu.DomainObject</span><span class="o">.</span><span class="n">noizu_entity</span><span class="p" data-group-id="9853891005-2">(</span><span class="p" data-group-id="9853891005-2">)</span><span class="w"> </span><span class="k" data-group-id="9853891005-3">do</span><span class="w">
    </span><span class="na">@json</span><span class="w"> </span><span class="err">{</span><span class="ss">:mobile</span><span class="p">,</span><span class="w"> </span><span class="ss">embed</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9853891005-4">[</span><span class="p" data-group-id="9853891005-5">{</span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="ss">as</span><span class="p">:</span><span class="w">  </span><span class="ss">:oh_hi</span><span class="p" data-group-id="9853891005-5">}</span><span class="p" data-group-id="9853891005-4">]</span><span class="w">
    </span><span class="n">public_field</span><span class="w"> </span><span class="ss">:description</span><span class="w">
  </span><span class="k" data-group-id="9853891005-3">end</span><span class="w">
</span><span class="k" data-group-id="9853891005-1">end</span><span class="w">

</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9853891005-6">%</span><span class="nc" data-group-id="9853891005-6">Entity</span><span class="p" data-group-id="9853891005-6">{</span><span class="w">
    </span><span class="ss">description</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9853891005-7">%</span><span class="nc" data-group-id="9853891005-7">VersionedString</span><span class="p" data-group-id="9853891005-7">{</span><span class="ss">identifier</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="ss">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mark&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">created_on</span><span class="p">:</span><span class="w"> </span><span class="ss">:tuesday</span><span class="p" data-group-id="9853891005-7">}</span><span class="w">
</span><span class="p" data-group-id="9853891005-6">}</span><span class="w">


</span><span class="c1"># Poison.encode!(a, json_format: :mobile)</span><span class="w">
</span><span class="p" data-group-id="9853891005-8">{</span><span class="ss">identifier</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">oh_hi</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mark&quot;</span><span class="p" data-group-id="9853891005-8">}</span><span class="w">

</span><span class="c1"># Poison.encode!(a, json_format: :admin)</span><span class="w">
</span><span class="p" data-group-id="9853891005-9">{</span><span class="ss">identifier</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">description</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9853891005-10">%{</span><span class="ss">identifier</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="ss">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mark&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">created_on</span><span class="p">:</span><span class="w"> </span><span class="ss">:tuesday</span><span class="p" data-group-id="9853891005-10">}</span><span class="p" data-group-id="9853891005-9">}</span><span class="w">
</span></code></pre><h1>Content Permission Annotation and Fields</h1><ul><li>Flag fields that should only be accessible by administrators, owning user, or users owner has shared with with field types and annotation. Flag PII fields automatically suppress in log output by default.</li></ul><pre><code class="makeup elixir"><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Entity</span><span class="w"> </span><span class="k" data-group-id="4613228888-1">do</span><span class="w">
    </span><span class="na">@universal_identifier</span><span class="w"> </span><span class="no">true</span><span class="w">
    </span><span class="nc">Noizu.DomainObject</span><span class="o">.</span><span class="n">noizu_entity</span><span class="w"> </span><span class="k" data-group-id="4613228888-2">do</span><span class="w">
    </span><span class="na">@permissions</span><span class="w"> </span><span class="p" data-group-id="4613228888-3">{</span><span class="p" data-group-id="4613228888-4">[</span><span class="ss">:view</span><span class="p">,</span><span class="w"> </span><span class="ss">:index</span><span class="p" data-group-id="4613228888-4">]</span><span class="p">,</span><span class="w"> </span><span class="ss">:unrestricted</span><span class="p" data-group-id="4613228888-3">}</span><span class="w">
    </span><span class="n">identifier</span><span class="w"> </span><span class="ss">:integer</span><span class="w">
    
     </span><span class="n">public_field</span><span class="w"> </span><span class="ss">:owner</span><span class="w">
    
     </span><span class="na">@json</span><span class="w"> </span><span class="p" data-group-id="4613228888-5">{</span><span class="ss">:*</span><span class="p">,</span><span class="w"> </span><span class="ss">:ignore</span><span class="p" data-group-id="4613228888-5">}</span><span class="w">  </span><span class="c1"># don&#39;t include this field by default in json response</span><span class="w">
     </span><span class="na">@json</span><span class="w"> </span><span class="p" data-group-id="4613228888-6">{</span><span class="ss">:admin_api</span><span class="p">,</span><span class="w"> </span><span class="ss">:include</span><span class="p" data-group-id="4613228888-6">}</span><span class="w"> </span><span class="c1"># except for admin_api formatted calls. </span><span class="w">
     </span><span class="n">public_field</span><span class="w"> </span><span class="ss">:last_login</span><span class="w">
    
      </span><span class="c1"># User (programmer) defined permission check - when attempting to access :bio check UserShare.has_permission? method to see if api caller has permission to view. </span><span class="w">
      </span><span class="na">@permissions</span><span class="w"> </span><span class="ss">:view</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4613228888-7">{</span><span class="ss">:restricted</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4613228888-8">{</span><span class="nc">UserShare</span><span class="p">,</span><span class="w"> </span><span class="ss">:has_permission?</span><span class="p" data-group-id="4613228888-8">}</span><span class="p" data-group-id="4613228888-7">}</span><span class="w">
      </span><span class="n">user_field</span><span class="w"> </span><span class="ss">:bio</span><span class="w">
    
      </span><span class="c1"># Only users with :account_moderator permission (granted by ACL - admin group membership} can edit/set   </span><span class="w">
      </span><span class="c1"># All callers can view the account_flag field. </span><span class="w">
      </span><span class="na">@permissions</span><span class="w"> </span><span class="p" data-group-id="4613228888-9">{</span><span class="ss">:*</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4613228888-10">{</span><span class="ss">:has_permission</span><span class="p">:</span><span class="w"> </span><span class="ss">:account_moderator</span><span class="p" data-group-id="4613228888-10">}</span><span class="p" data-group-id="4613228888-9">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4613228888-11">{</span><span class="ss">:view</span><span class="p">,</span><span class="w"> </span><span class="ss">:unrestricted</span><span class="p" data-group-id="4613228888-11">}</span><span class="w">
      </span><span class="na">@restricted_field</span><span class="w"> </span><span class="ss">:account_flag</span><span class="w"> 
    
      </span><span class="c1"># Only users who are members of the :system_account or :super_admin group may access.</span><span class="w">
      </span><span class="na">@permissions</span><span class="w"> </span><span class="p" data-group-id="4613228888-12">{</span><span class="ss">:*</span><span class="p">,</span><span class="w">  </span><span class="p" data-group-id="4613228888-13">[</span><span class="p" data-group-id="4613228888-14">{</span><span class="ss">:in_group</span><span class="p">:</span><span class="w"> </span><span class="ss">:system_account</span><span class="p" data-group-id="4613228888-14">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4613228888-15">{</span><span class="ss">:in_group</span><span class="p">:</span><span class="w"> </span><span class="ss">:super_admin</span><span class="p" data-group-id="4613228888-15">}</span><span class="p" data-group-id="4613228888-13">]</span><span class="p" data-group-id="4613228888-12">}</span><span class="w">
      </span><span class="na">@restricted_field</span><span class="w"> </span><span class="ss">:account_flag</span><span class="w"> 
    
     </span><span class="c1"># Low security (level 3) personally identifiable data. Can be included in most logs and exception messages.</span><span class="w">
      </span><span class="na">@pii</span><span class="w"> </span><span class="n">level_3</span><span class="w">
      </span><span class="n">restricted_field</span><span class="w"> </span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="nc">Noizu.VersionedName.Type</span><span class="w">
    
     </span><span class="c1"># High Security (level 0) PII. Only include in the most secure logs, strip from raised exceptions, etc.</span><span class="w">
      </span><span class="na">@pii</span><span class="w"> </span><span class="ss">:level_0</span><span class="w">
      </span><span class="n">restricted_field</span><span class="w"> </span><span class="ss">:social_security</span><span class="w">
    </span><span class="k" data-group-id="4613228888-2">end</span><span class="w">
</span><span class="k" data-group-id="4613228888-1">end</span><span class="w">

</span><span class="c1"># User (programmer) defined permission check. This example allows caller to view user.bio if the user</span><span class="w">
</span><span class="c1"># account is public or the caller is a friend with the user who the bio field belongs to.</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">UserShare</span><span class="w"> </span><span class="k" data-group-id="4613228888-16">do</span><span class="w">
    </span><span class="c1"># the caller is a friend of the user, otherwise it restricts access and the bio field will not be returned to the caller.</span><span class="w">
    </span><span class="kd">def</span><span class="w"> </span><span class="nf">has_permission?</span><span class="p" data-group-id="4613228888-17">(</span><span class="ss">:view</span><span class="p">,</span><span class="w"> </span><span class="ss">:bio</span><span class="p">,</span><span class="w"> </span><span class="n">entity</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p" data-group-id="4613228888-17">)</span><span class="w"> </span><span class="k" data-group-id="4613228888-18">do</span><span class="w">
      </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Noizu.ERP</span><span class="o">.</span><span class="n">entity!</span><span class="p" data-group-id="4613228888-19">(</span><span class="n">entity</span><span class="o">.</span><span class="n">owner</span><span class="p" data-group-id="4613228888-19">)</span><span class="w">
      </span><span class="k">cond</span><span class="w"> </span><span class="k" data-group-id="4613228888-20">do</span><span class="w">
        </span><span class="n">user</span><span class="o">.</span><span class="n">public_account?</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="ss">:permission_granted</span><span class="w">
        </span><span class="n">user</span><span class="o">.</span><span class="n">friend?</span><span class="p" data-group-id="4613228888-21">(</span><span class="n">context</span><span class="o">.</span><span class="n">caller</span><span class="p" data-group-id="4613228888-21">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="ss">:permission_granted</span><span class="w">
      </span><span class="ss">:else</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="ss">:permission_denied</span><span class="w">
      </span><span class="k" data-group-id="4613228888-20">end</span><span class="w">
    </span><span class="k" data-group-id="4613228888-18">end</span><span class="w">
</span><span class="k" data-group-id="4613228888-16">end</span><span class="w">
</span></code></pre><h1>Built in Multiple Datastore(s) + Cache management.</h1><ul><li>Scaffolding managing keeping different datastores and cache layers up to date.</li></ul><pre><code class="makeup elixir"><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">RootLevel.NestedLevel.Image</span><span class="w"> </span><span class="k" data-group-id="4267376096-1">do</span><span class="w">
    </span><span class="kn">use</span><span class="w"> </span><span class="nc">Noizu.DomainObject</span><span class="w">
    </span><span class="na">@vsn</span><span class="w"> </span><span class="mf">1.0</span><span class="w">
    </span><span class="na">@sref</span><span class="w"> </span><span class="s">&quot;image&quot;</span><span class="w">
    
    </span><span class="c1"># Default Mnesia Database  (RootLevelSchema.Database) and table.  RootLevelSchema.Repo.database() &lt;&gt; &quot;NestedLevel.Image.Table&quot;</span><span class="w">
    </span><span class="na">@persistence_layer</span><span class="w"> </span><span class="ss">:mnesia</span><span class="w">
    
    </span><span class="c1"># Default Ecto Database/Repo (RootLevelSchema.Repo) and table.  RootLevelSchema.Repo.database() &lt;&gt; &quot;NestedLevel.Image.Table&quot;</span><span class="w">
    </span><span class="na">@persistence_layer</span><span class="w"> </span><span class="p" data-group-id="4267376096-2">{</span><span class="ss">:ecto</span><span class="p">,</span><span class="w"> </span><span class="ss">cascade?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w"> </span><span class="ss">fallback_load</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="4267376096-2">}</span><span class="w">
    
    </span><span class="c1"># Default Ecto Database with specific table, for example to allow lazy migration from a deprecated table</span><span class="w">
    </span><span class="na">@persistence_layer</span><span class="w"> </span><span class="p" data-group-id="4267376096-3">{</span><span class="ss">:ecto</span><span class="p">,</span><span class="w"> </span><span class="ss">cascade?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p">,</span><span class="w"> </span><span class="ss">fallback_load</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w"> </span><span class="ss">table</span><span class="p">:</span><span class="w"> </span><span class="nc">NoizuSchema.MySQL.PreviousDatabaseTable</span><span class="p" data-group-id="4267376096-3">}</span><span class="w">
    
    </span><span class="c1"># don&#39;t update/delete/create in legacy MSSQL database during crud operations. {cascade?: false}</span><span class="w">
    </span><span class="c1"># allow load from mssql if entity not found in :mnesia or :ecto (MySQL)</span><span class="w">
    </span><span class="na">@persistence_layer</span><span class="w"> </span><span class="p" data-group-id="4267376096-4">{</span><span class="nc">NoizuSchema.MSSQLRepo</span><span class="p">,</span><span class="w"> </span><span class="ss">cascade?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p">,</span><span class="w"> </span><span class="ss">fallback_load</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="4267376096-4">}</span><span class="w">
    
    
    </span><span class="c1"># call archive provider on_delete hook when deleted entity, allows archive implementation to save entry to archive storage.</span><span class="w">
    </span><span class="na">@persistence_layer</span><span class="w"> </span><span class="p" data-group-id="4267376096-5">{</span><span class="ss">:archive</span><span class="p">,</span><span class="w"> </span><span class="ss">cascade_delete?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="4267376096-5">}</span><span class="w"> </span><span class="c1"># call archive provider on_delete hook when deleted entity, allows archive implementation to save entry to archive storage.</span><span class="w">
    
    </span><span class="c1"># Cache to redis and precache/update cascade one changes.</span><span class="w">
    </span><span class="c1"># Don&#39;t return from Repo.create/update/delete until redis update complete (cascade_blocking: true),</span><span class="w">
    </span><span class="c1"># automatic cache delete after 600 seconds. {ttl: 600}</span><span class="w">
    </span><span class="na">@persistence_layer</span><span class="w"> </span><span class="p" data-group-id="4267376096-6">{</span><span class="ss">:redis</span><span class="p">,</span><span class="w"> </span><span class="ss">cascade?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w"> </span><span class="ss">cascade_blocking</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w"> </span><span class="ss">ttl</span><span class="p">:</span><span class="w"> </span><span class="mi">600</span><span class="p" data-group-id="4267376096-6">}</span><span class="w">

    
    </span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Entity</span><span class="w"> </span><span class="k" data-group-id="4267376096-7">do</span><span class="w">
      </span><span class="na">@universal_identifier</span><span class="w"> </span><span class="no">true</span><span class="w">
      </span><span class="nc">Noizu.DomainObject</span><span class="o">.</span><span class="n">noizu_entity</span><span class="w"> </span><span class="k" data-group-id="4267376096-8">do</span><span class="w">
        </span><span class="n">identifier</span><span class="w"> </span><span class="ss">:string</span><span class="w">
        </span><span class="n">ecto_identifier</span><span class="w"> </span><span class="ss">:integer</span><span class="w">
        </span><span class="n">public_fields</span><span class="w"> </span><span class="p" data-group-id="4267376096-9">[</span><span class="w">
        </span><span class="ss">:description</span><span class="p">,</span><span class="w">
        </span><span class="ss">:blur_hash</span><span class="p">,</span><span class="w">
        </span><span class="ss">:hash</span><span class="p">,</span><span class="w">
        </span><span class="ss">:base</span><span class="p">,</span><span class="w">
        </span><span class="ss">:source</span><span class="p">,</span><span class="w">
        </span><span class="ss">:base_dimensions</span><span class="p">,</span><span class="w">
        </span><span class="ss">:external</span><span class="p">,</span><span class="w">
        </span><span class="ss">:image_type</span><span class="p">,</span><span class="w">
        </span><span class="ss">:file_format</span><span class="p">,</span><span class="w">
        </span><span class="ss">:locale</span><span class="p">,</span><span class="w">
        </span><span class="ss">:localized</span><span class="p">,</span><span class="w">
        </span><span class="ss">:interactions</span><span class="p" data-group-id="4267376096-9">]</span><span class="w">
        </span><span class="n">public_fields</span><span class="w"> </span><span class="p" data-group-id="4267376096-10">[</span><span class="ss">:created_on</span><span class="p">,</span><span class="w"> </span><span class="ss">:modified_on</span><span class="p">,</span><span class="w"> </span><span class="ss">:deleted_on</span><span class="p" data-group-id="4267376096-10">]</span><span class="w">
      </span><span class="n">internal_fields</span><span class="w"> </span><span class="p" data-group-id="4267376096-11">[</span><span class="ss">:moderation_status</span><span class="p">,</span><span class="w"> </span><span class="ss">:content_flag</span><span class="p">,</span><span class="w"> </span><span class="ss">:sphinx_index</span><span class="p" data-group-id="4267376096-11">]</span><span class="w">
    </span><span class="k" data-group-id="4267376096-8">end</span><span class="w">


    </span><span class="kd">def</span><span class="w"> </span><span class="nf">__from_record__</span><span class="p" data-group-id="4267376096-12">(</span><span class="ss">:NoizuSchema</span><span class="o">.</span><span class="nc">MSSQLRepo</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4267376096-13">%</span><span class="nc" data-group-id="4267376096-13">NoizuSchema.MSSQL.NestedLevel.ImageTable</span><span class="p" data-group-id="4267376096-13">{</span><span class="p" data-group-id="4267376096-13">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p" data-group-id="4267376096-12">)</span><span class="w"> </span><span class="k" data-group-id="4267376096-14">do</span><span class="w">
      </span><span class="p">%</span><span class="bp">__MODULE__</span><span class="p" data-group-id="4267376096-15">{</span><span class="ss">custom_table_to_entity_provider</span><span class="p">:</span><span class="w"> </span><span class="n">record</span><span class="o">.</span><span class="n">field</span><span class="p" data-group-id="4267376096-15">}</span><span class="w">
    </span><span class="k" data-group-id="4267376096-14">end</span><span class="w">
    </span><span class="kd">def</span><span class="w"> </span><span class="nf">__from_record__</span><span class="p" data-group-id="4267376096-16">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p" data-group-id="4267376096-16">)</span><span class="w"> </span><span class="k" data-group-id="4267376096-17">do</span><span class="w">
      </span><span class="c1"># fallback to default providers. automatically injected by noizu_entity&#39;s before_compile method. </span><span class="w">
      </span><span class="k">super</span><span class="p" data-group-id="4267376096-18">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p" data-group-id="4267376096-18">)</span><span class="w">
    </span><span class="k" data-group-id="4267376096-17">end</span><span class="w">
  </span><span class="k" data-group-id="4267376096-7">end</span><span class="w">
</span><span class="k" data-group-id="4267376096-1">end</span><span class="w">
</span></code></pre><h1>Sphinx Indexing Support</h1><ul><li>index annotation and definitions automate search index population and formatting</li></ul><pre><code class="makeup elixir"><span class="w">
</span><span class="c1"># Automatically apply 5.2 km anonymization to location fields, always strip pii level 1 or lower</span><span class="w">
</span><span class="c1"># Automatically generate Noizu.#{Base}.Indexer module due to inline: :sphinx argument</span><span class="w">
</span><span class="na">@index</span><span class="w"> </span><span class="ss">self</span><span class="p">:</span><span class="w"> </span><span class="ss">:sphinx</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:realtime</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8202796096-1">[</span><span class="ss">defaults</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8202796096-2">[</span><span class="p" data-group-id="8202796096-3">{</span><span class="nc">MyApp.Sphinx.LocationIndex</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8202796096-4">[</span><span class="ss">anonymize</span><span class="p">:</span><span class="w"> </span><span class="mf">5.2</span><span class="p" data-group-id="8202796096-4">]</span><span class="p" data-group-id="8202796096-3">}</span><span class="p" data-group-id="8202796096-2">]</span><span class="p">,</span><span class="w"> </span><span class="ss">pii</span><span class="p">:</span><span class="w"> </span><span class="ss">:level_2</span><span class="p" data-group-id="8202796096-1">]</span><span class="w">

</span><span class="c1"># include sensitive user data in index | runtime meta data scanning allows this index :admin_index to cover multiple entity types with out additional user configuration</span><span class="w">
</span><span class="na">@index</span><span class="w"> </span><span class="nc">MyApp.Admin.Indexer</span><span class="p">,</span><span class="w"> </span><span class="ss">pii</span><span class="p">:</span><span class="w"> </span><span class="ss">:level_0</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Entity</span><span class="w"> </span><span class="k" data-group-id="8202796096-5">do</span><span class="w">
  </span><span class="na">@universal_identifier</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="nc">Noizu.DomainObject</span><span class="o">.</span><span class="n">noizu_entity</span><span class="w"> </span><span class="k" data-group-id="8202796096-6">do</span><span class="w">
  </span><span class="na">@permissions</span><span class="w"> </span><span class="p" data-group-id="8202796096-7">{</span><span class="p" data-group-id="8202796096-8">[</span><span class="ss">:view</span><span class="p">,</span><span class="w"> </span><span class="ss">:index</span><span class="p" data-group-id="8202796096-8">]</span><span class="p">,</span><span class="w"> </span><span class="ss">:unrestricted</span><span class="p" data-group-id="8202796096-7">}</span><span class="w">
  </span><span class="n">identifier</span><span class="w"> </span><span class="ss">:integer</span><span class="w">
  
  </span><span class="na">@index</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="n">restricted_field</span><span class="w"> </span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="nc">MyApp.VersionedName.Type</span><span class="w">
  
  </span><span class="c1"># Allow custom index controls, such as allowing users with private accounts to exclude their details from search. </span><span class="w">
  </span><span class="na">@index</span><span class="w"> </span><span class="p" data-group-id="8202796096-9">{</span><span class="ss">:user_defined</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8202796096-10">{</span><span class="nc">MyApp.UserEntity</span><span class="p">,</span><span class="w"> </span><span class="ss">:index</span><span class="p" data-group-id="8202796096-10">}</span><span class="p" data-group-id="8202796096-9">}</span><span class="w">
  </span><span class="n">restricted_field</span><span class="w"> </span><span class="ss">:gender</span><span class="w">
  
  </span><span class="na">@index</span><span class="w"> </span><span class="p" data-group-id="8202796096-11">{</span><span class="nc">MyApp.Admin.Indexer</span><span class="p">,</span><span class="w"> </span><span class="ss">as</span><span class="p">:</span><span class="w"> </span><span class="ss">:blob</span><span class="p" data-group-id="8202796096-11">}</span><span class="w"> </span><span class="c1"># Include in multiple entity admin search index, embed field in json blob as admin index will not include entity specific fields like this.  </span><span class="w">
  </span><span class="na">@index</span><span class="w"> </span><span class="p" data-group-id="8202796096-12">{</span><span class="ss">:inline</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8202796096-13">{</span><span class="ss">:user_defined</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8202796096-14">{</span><span class="nc">MyApp.UserEntity</span><span class="p">,</span><span class="w"> </span><span class="ss">:index</span><span class="p" data-group-id="8202796096-14">}</span><span class="p" data-group-id="8202796096-13">}</span><span class="p" data-group-id="8202796096-12">}</span><span class="w">
  </span><span class="n">restricted_field</span><span class="w"> </span><span class="ss">:orientation</span><span class="w">
  
  </span><span class="c1"># use MyAppIndex.Location handler to add  #{field}_longitude, #{field}_latitude, #{field}_zone, and #{field}_radius indexes for this field e.g. geo: %{longitude: 123.3, latitude: 432.0, radius: 5.2} </span><span class="w">
  </span><span class="na">@index</span><span class="w"> </span><span class="nc">MyApp.Admin.Indexer</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8202796096-15">[</span><span class="ss">with</span><span class="p">:</span><span class="w"> </span><span class="nc">MyAppIndex.Location</span><span class="p" data-group-id="8202796096-15">]</span><span class="err">}</span><span class="w">
  </span><span class="na">@index</span><span class="w"> </span><span class="ss">inline</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8202796096-16">[</span><span class="ss">with</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8202796096-17">{</span><span class="nc">MyAppIndex.Location</span><span class="p">,</span><span class="w"> </span><span class="ss">anonymize</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8202796096-18">[</span><span class="ss">radius</span><span class="p">:</span><span class="w"> </span><span class="mi">25</span><span class="p" data-group-id="8202796096-18">]</span><span class="p" data-group-id="8202796096-17">}</span><span class="p" data-group-id="8202796096-16">]</span><span class="w">  </span><span class="c1"># Anonymize location to 25 radius bubble </span><span class="w">
  </span><span class="n">restricted_field</span><span class="w"> </span><span class="ss">:geo</span><span class="w">
  
  </span><span class="na">@index</span><span class="w"> </span><span class="no">true</span><span class="w"> </span><span class="c1"># Type Specification (MyAppSchema.Geo) will automatically trigger MyAppIndex.Location for unpacking -&gt; :home_town_longitude, :home_town_latitude, :home_town_radius ...</span><span class="w">
  </span><span class="n">restricted_field</span><span class="w"> </span><span class="ss">:home_town</span><span class="p">,</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="nc">MyAppSchema.Geo</span><span class="w">
    
  </span><span class="c1"># Todo</span><span class="w">
  </span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Jety.Admin.Indexer</span><span class="w"> </span><span class="k" data-group-id="8202796096-19">do</span><span class="w">
    </span><span class="kn">use</span><span class="w"> </span><span class="nc">Noizu.DomainObject.Sphinx.Indexer</span><span class="w">
    </span><span class="c1"># ...</span><span class="w">
  </span><span class="k" data-group-id="8202796096-19">end</span><span class="w">
</span></code></pre><h1>Built in Logging/Telemetry</h1><ul><li><p>Collate-able logs, and telemetrics automatically generated as entities are edited, accessed, cached, etc.</p></li><li><p>Unique Numeric Database Identifiers</p></li><li><p>Table + Node section of Identifiers allow mapping of universal ids to specific entity (entity encoded in identifiers to mimic the elixir framework's {:ref, _, id} concept.  Greatly simplifies sphinx index id lookup, provides benefits of GUIDs while retaining much faster 64 bit unsigned int matching.Eventually very busy tables will need to break out into UUIDs as we approach the limits of 64 bit universal identifiers.</p></li></ul><pre><code class="makeup elixir"><span class="w">
</span><span class="nc">MyApp.User.Repo</span><span class="o">.</span><span class="n">generate_identifier!</span><span class="p" data-group-id="3747850131-1">(</span><span class="p" data-group-id="3747850131-1">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">  </span><span class="mi">1234005001</span><span class="w"> </span><span class="p">,</span><span class="w">  </span><span class="n">where</span><span class="w"> </span><span class="mi">1234</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="nc">User.Entity</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">incrementor</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="mi">005</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">unique</span><span class="w"> </span><span class="n">identifier</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="nc">User.Entity</span><span class="o">/</span><span class="nc">Table</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="mi">001</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">node</span><span class="o">/</span><span class="n">server</span><span class="w"> </span><span class="n">specific</span><span class="w"> </span><span class="n">identifier</span><span class="o">.</span><span class="w">
</span><span class="c1"># Scaffolding automatically injects UniversalIdentifierResolution{1234005001,  ref: {:ref, UserEntity, 1234005001}}} entry</span><span class="w">
</span><span class="c1"># If User was a univeral_lookup but not universal_identifier entity it&#39;s id would be 1234, while the universal identifier would reamain 1234005001 -&gt; UniversalIdentifierResolution{1234005001, ref: {:ref, User.Entity, 1234}}</span><span class="w">
</span></code></pre><ul><li><p>Built in handling of Atom to Enum mapping when switching between RDMS and elixir.</p></li><li><p>Look Up Entities automatically generate Ecto types to avoid the need to manually map back and forth between number enumerators and their associated elixir atoms.Thus we can do something like the following</p></li></ul><pre><code class="makeup elixir"><span class="w">
</span><span class="n">schema</span><span class="w"> </span><span class="s">&quot;table&quot;</span><span class="w"> </span><span class="k" data-group-id="9327919012-1">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">status</span><span class="p">:</span><span class="w">  </span><span class="nc">MyApp.Status.EctoEnumType</span><span class="w">
</span><span class="k" data-group-id="9327919012-1">end</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Status.Entity</span><span class="w"> </span><span class="k" data-group-id="9327919012-2">do</span><span class="w">
    </span><span class="nc">MyApp.ElixirScaffolding</span><span class="o">.</span><span class="n">enum_table</span><span class="p" data-group-id="9327919012-3">(</span><span class="p" data-group-id="9327919012-4">[</span><span class="ss">online</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">offline</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="9327919012-4">]</span><span class="p" data-group-id="9327919012-3">)</span><span class="w">
</span><span class="k" data-group-id="9327919012-2">end</span><span class="w">

</span><span class="p" data-group-id="9327919012-5">%</span><span class="nc" data-group-id="9327919012-5">MySQL.Table</span><span class="p" data-group-id="9327919012-5">{</span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="ss">:online</span><span class="p" data-group-id="9327919012-5">}</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">create</span><span class="p" data-group-id="9327919012-6">(</span><span class="p" data-group-id="9327919012-6">)</span><span class="w">
</span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="nc">Repo</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="9327919012-7">(</span><span class="nc">MySQL.Table</span><span class="p">,</span><span class="w"> </span><span class="n">identifier</span><span class="p" data-group-id="9327919012-7">)</span><span class="w">
</span><span class="k">if</span><span class="w"> </span><span class="n">t</span><span class="o">.</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:offline</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">stuff</span><span class="p" data-group-id="9327919012-8">(</span><span class="p" data-group-id="9327919012-8">)</span><span class="w">
</span></code></pre><p>rather than the much more verbose equivalent</p><pre><code class="makeup elixir"><span class="w">
</span><span class="n">schema</span><span class="w"> </span><span class="s">&quot;table&quot;</span><span class="w"> </span><span class="k" data-group-id="8128668922-1">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="n">identifier</span><span class="w">
</span><span class="k" data-group-id="8128668922-1">end</span><span class="w">


</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Status.Entity</span><span class="w"> </span><span class="k" data-group-id="8128668922-2">do</span><span class="w">
    </span><span class="n">...</span><span class="w">
    </span><span class="na">@enum_to_atom</span><span class="w"> </span><span class="p" data-group-id="8128668922-3">%{</span><span class="w">
    </span><span class="mi">0</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">:online</span><span class="p">,</span><span class="w">
    </span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">:offline</span><span class="p">,</span><span class="w">
    </span><span class="n">...</span><span class="w">
    </span><span class="p" data-group-id="8128668922-3">}</span><span class="w">
    
    </span><span class="na">@atom_to_enum</span><span class="w"> </span><span class="p" data-group-id="8128668922-4">%{</span><span class="w">
    </span><span class="ss">online</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="ss">offline</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="n">...</span><span class="w">
    </span><span class="p" data-group-id="8128668922-4">}</span><span class="w">
    
    </span><span class="kd">def</span><span class="w"> </span><span class="nf">enum_to_atom</span><span class="p" data-group-id="8128668922-5">(</span><span class="n">v</span><span class="p" data-group-id="8128668922-5">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="na">@enum_to_atom</span><span class="p" data-group-id="8128668922-6">[</span><span class="n">v</span><span class="p" data-group-id="8128668922-6">]</span><span class="w">
</span><span class="k" data-group-id="8128668922-2">end</span><span class="w">

</span><span class="p" data-group-id="8128668922-7">%</span><span class="nc" data-group-id="8128668922-7">MySQL.Table</span><span class="p" data-group-id="8128668922-7">{</span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="nc">MyApp.Status.Entity</span><span class="o">.</span><span class="n">atom_to_enum</span><span class="p" data-group-id="8128668922-8">(</span><span class="ss">:status</span><span class="p" data-group-id="8128668922-8">)</span><span class="p" data-group-id="8128668922-7">}</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">create</span><span class="p" data-group-id="8128668922-9">(</span><span class="p" data-group-id="8128668922-9">)</span><span class="w">
</span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="8128668922-10">(</span><span class="nc">MySQL.Table</span><span class="p">,</span><span class="w"> </span><span class="n">identifier</span><span class="p" data-group-id="8128668922-10">)</span><span class="w">
</span><span class="k">if</span><span class="w"> </span><span class="nc">MyApp.Status.Entity</span><span class="o">.</span><span class="n">enum_to_atom</span><span class="p" data-group-id="8128668922-11">(</span><span class="n">t</span><span class="o">.</span><span class="n">status</span><span class="p" data-group-id="8128668922-11">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:offline</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">stuff</span><span class="p" data-group-id="8128668922-12">(</span><span class="p" data-group-id="8128668922-12">)</span><span class="w">
</span></code></pre><ul><li><p>Reduce Lines of Code &amp; Maintenance*</p></li><li><p>Scaffolding + Annotation takes care of basic Json/Database Crud</p></li><li><p>Aspect-Oriented-Programming via annotation and macros + config options allow fine tuned extensions and customization of objects.</p></li><li><p>Straight forward roll out of cluster wide aop behaviors/extensions.</p></li></ul><p>For Example</p><pre><code class="makeup elixir"><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Image.Type</span><span class="w"> </span><span class="k" data-group-id="4663774615-1">do</span><span class="w">
    </span><span class="na">@vsn</span><span class="w"> </span><span class="mf">1.0</span><span class="w">
    </span><span class="na">@sref</span><span class="w"> </span><span class="s">&quot;image-type&quot;</span><span class="w">
    </span><span class="kn">use</span><span class="w"> </span><span class="nc">MyApp.ElixirScaffolding.EnumEntity</span><span class="p">,</span><span class="w">
    </span><span class="ss">values</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4663774615-2">[</span><span class="ss">none</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">profile</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">background</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">post</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="ss">user_upload</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="ss">logo</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="ss">moment</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="ss">shout_out</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="p" data-group-id="4663774615-2">]</span><span class="w">
</span><span class="k" data-group-id="4663774615-1">end</span><span class="w">
</span></code></pre><ul><li><p>Automatically generates</p><ul><li>Image.Type.Entity</li><li>Image.Type.Repo</li><li>Image.Type.EctoEnumType</li><li>Image.Type.EctoEnumReference</li><li>MyApp.EnumEntity.Indexer  # Search all entities or entities of a specific type to bring up matches for api text autocomplete</li><li>Noizu.ERP.ref handlers for (Image.Type.Entity, Mysql.Image.Type.Table, Mnesia.Image.Type.Table)</li></ul></li><li><p>Name/Description Versioning  - (Uses a Noizu.VersionedString that provides simple revision history of changes to fields title/description)</p></li><li><p>Runtime Noizu.ERP ref string parser extension to handle &quot;ref.image-type.1234&quot; formatted reference strings.</p></li></ul><h1>Crud</h1><p>Json formatting (for mobile view collapse to string <code class="inline">%MyApp.Image.Type{1, description: %{title: &quot;User&quot;}}) -&gt; &quot;User&quot;</code></p><p>Data setup helpers.</p><p>and  this line in  <code class="inline">jetzy/lib/jetzy_schema/mysql/enum_tables.ex</code></p><pre><code class="makeup elixir"><span class="w">
</span><span class="kn">require</span><span class="w"> </span><span class="nc">MyAppSchema.EnumTableBehaviour</span><span class="w">
</span><span class="c1"># . . .</span><span class="w">
</span><span class="nc">MyAppSchema.EnumTableBehaviour</span><span class="o">.</span><span class="n">table</span><span class="p" data-group-id="3676240505-1">(</span><span class="ss">:image_type</span><span class="p">,</span><span class="w"> </span><span class="nc">Elixir.MyApp.Image.Type.Entity</span><span class="p" data-group-id="3676240505-1">)</span><span class="w">
</span><span class="c1"># . . .</span><span class="w">
</span></code></pre><p>generates a MyAppSchema.MySQL.Image.Type.Table currently equivalent to:</p><pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyAppSchema.MySQL.Image.TypeTable</span><span class="w"> </span><span class="k" data-group-id="9576912138-1">do</span><span class="w">
</span><span class="na">@primary_key</span><span class="w"> </span><span class="p" data-group-id="9576912138-2">{</span><span class="ss">:identifier</span><span class="p">,</span><span class="w"> </span><span class="ss">:id</span><span class="p">,</span><span class="w"> </span><span class="ss">autogenerate</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p" data-group-id="9576912138-2">}</span><span class="w">
</span><span class="na">@derive</span><span class="w"> </span><span class="p" data-group-id="9576912138-3">{</span><span class="nc">Phoenix.Param</span><span class="p">,</span><span class="w"> </span><span class="ss">key</span><span class="p">:</span><span class="w"> </span><span class="ss">:identifier</span><span class="p" data-group-id="9576912138-3">}</span><span class="w">
</span><span class="n">schema</span><span class="w"> </span><span class="s">&quot;image_type&quot;</span><span class="w"> </span><span class="k" data-group-id="9576912138-4">do</span><span class="w">
</span><span class="c1">#field :description, MyApp.VersionedString.EctoUniversalReference</span><span class="w">

      </span><span class="c1">#  Standard Time Stamps</span><span class="w">
      </span><span class="n">field</span><span class="w"> </span><span class="ss">:created_on</span><span class="p">,</span><span class="w"> </span><span class="ss">:utc_datetime_usec</span><span class="w">
      </span><span class="n">field</span><span class="w"> </span><span class="ss">:modified_on</span><span class="p">,</span><span class="w"> </span><span class="ss">:utc_datetime_usec</span><span class="w">
      </span><span class="n">field</span><span class="w"> </span><span class="ss">:deleted_on</span><span class="p">,</span><span class="w"> </span><span class="ss">:utc_datetime_usec</span><span class="w">
    </span><span class="k" data-group-id="9576912138-4">end</span><span class="w">

    
  </span><span class="c1">#-------------------------------</span><span class="w">
  </span><span class="c1"># new</span><span class="w">
  </span><span class="c1">#-------------------------------</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">new</span><span class="p" data-group-id="9576912138-5">(</span><span class="n">options</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="9576912138-6">%{</span><span class="p" data-group-id="9576912138-6">}</span><span class="p" data-group-id="9576912138-5">)</span><span class="w"> </span><span class="k" data-group-id="9576912138-7">do</span><span class="w">
    </span><span class="n">struct</span><span class="p" data-group-id="9576912138-8">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p" data-group-id="9576912138-8">)</span><span class="w">
  </span><span class="k" data-group-id="9576912138-7">end</span><span class="w">

  </span><span class="c1">#-------------------------------</span><span class="w">
  </span><span class="c1"># changeset</span><span class="w">
  </span><span class="c1">#-------------------------------</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">changeset</span><span class="p" data-group-id="9576912138-9">(</span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="9576912138-9">)</span><span class="w"> </span><span class="k" data-group-id="9576912138-10">do</span><span class="w">
    </span><span class="n">fields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">keys</span><span class="p" data-group-id="9576912138-11">(</span><span class="n">record</span><span class="p" data-group-id="9576912138-11">)</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="p" data-group-id="9576912138-12">[</span><span class="ss">:__struct__</span><span class="p">,</span><span class="w"> </span><span class="ss">:__schema__</span><span class="p">,</span><span class="w"> </span><span class="ss">:__meta__</span><span class="p" data-group-id="9576912138-12">]</span><span class="w">
    </span><span class="n">record</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">cast</span><span class="p" data-group-id="9576912138-13">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">fields</span><span class="p" data-group-id="9576912138-13">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">validate_required</span><span class="p" data-group-id="9576912138-14">(</span><span class="p" data-group-id="9576912138-15">[</span><span class="p" data-group-id="9576912138-15">]</span><span class="p" data-group-id="9576912138-14">)</span><span class="w">
  </span><span class="k" data-group-id="9576912138-10">end</span><span class="w">


  
  </span><span class="kd">defdelegate</span><span class="w"> </span><span class="c">__entity__</span><span class="p" data-group-id="9576912138-16">(</span><span class="p" data-group-id="9576912138-16">)</span><span class="p">,</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="nc">MyApp.Image.Type.Entity</span><span class="w">
  </span><span class="kd">defdelegate</span><span class="w"> </span><span class="c">__repo__</span><span class="p" data-group-id="9576912138-17">(</span><span class="p" data-group-id="9576912138-17">)</span><span class="p">,</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="nc">MyApp.Image.Type.Entity</span><span class="w">
  </span><span class="kd">defdelegate</span><span class="w"> </span><span class="c">__sref__</span><span class="p" data-group-id="9576912138-18">(</span><span class="p" data-group-id="9576912138-18">)</span><span class="p">,</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="nc">MyApp.Image.Type.Entity</span><span class="w">
  </span><span class="kd">defdelegate</span><span class="w"> </span><span class="c">__erp__</span><span class="p" data-group-id="9576912138-19">(</span><span class="p" data-group-id="9576912138-19">)</span><span class="p">,</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="nc">MyApp.Image.Type.Entity</span><span class="w">

  </span><span class="kd">defdelegate</span><span class="w"> </span><span class="c">__persistence__</span><span class="p" data-group-id="9576912138-20">(</span><span class="n">setting</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="ss">:all</span><span class="p" data-group-id="9576912138-20">)</span><span class="p">,</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w">  </span><span class="nc">MyApp.Image.Type</span><span class="w">
  </span><span class="kd">defdelegate</span><span class="w"> </span><span class="c">__persistence__</span><span class="p" data-group-id="9576912138-21">(</span><span class="n">selector</span><span class="p">,</span><span class="w"> </span><span class="n">setting</span><span class="p" data-group-id="9576912138-21">)</span><span class="p">,</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w">  </span><span class="nc">MyApp.Image.Type</span><span class="w">
  </span><span class="kd">defdelegate</span><span class="w"> </span><span class="c">__nmid__</span><span class="p" data-group-id="9576912138-22">(</span><span class="n">setting</span><span class="p" data-group-id="9576912138-22">)</span><span class="p">,</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="nc">MyApp.Image.Type.Entity</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">__schema_table__</span><span class="p" data-group-id="9576912138-23">(</span><span class="p" data-group-id="9576912138-23">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="ss">:image_type</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">__noizu_info__</span><span class="p" data-group-id="9576912138-24">(</span><span class="ss">:type</span><span class="p" data-group-id="9576912138-24">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="ss">:enum_table</span><span class="w">
  </span><span class="kd">defdelegate</span><span class="w"> </span><span class="c">__noizu_info__</span><span class="p" data-group-id="9576912138-25">(</span><span class="n">setting</span><span class="p" data-group-id="9576912138-25">)</span><span class="p">,</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w">  </span><span class="nc">MyApp.Image.Type</span><span class="w">
</span><span class="k" data-group-id="9576912138-1">end</span><span class="w">
</span></code></pre><h1>Existing</h1><h2 id="refs" class="section-heading">
  <a href="#refs" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Refs
</h2>
<p>Refs provide a universal way for database records to reference other internal or external entities. They take the form of a tuple as follows: {:ref, Entity.Module, identifier} where
Entity.Module is the type of entity we are referencing and provides a method entity(nmid) that is capable of fetching the entity referenced by the listed identifier.</p><p>This makes it straight forward for a table to reference various other entity types in a generic way. Additionally the Noizu.ERP (Entity Reference Protocol) provides a straight forward
mechanism for handling references with out knowing in advance if they have been expanded or their exact type.</p><p>The EntityReferenceProtocol (alias Noizu.ERP, as: EntityReferenceProtocol) is defined as follows:</p><pre><code class="makeup elixir"><span class="w">  </span><span class="kd">defprotocol</span><span class="w"> </span><span class="nc">Noizu.ERP</span><span class="w"> </span><span class="k" data-group-id="4272266914-1">do</span><span class="w">
    </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Cast to noizu reference object&quot;</span><span class="w">
    </span><span class="kd">def</span><span class="w"> </span><span class="nf">ref</span><span class="p" data-group-id="4272266914-2">(</span><span class="n">obj</span><span class="p" data-group-id="4272266914-2">)</span><span class="w">

    </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Cast to noizu string reference object&quot;</span><span class="w">
    </span><span class="kd">def</span><span class="w"> </span><span class="nf">sref</span><span class="p" data-group-id="4272266914-3">(</span><span class="n">obj</span><span class="p" data-group-id="4272266914-3">)</span><span class="w">

    </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Convert to persistence object. Options may be passed to coordinate actions like expanding embedded references.&quot;</span><span class="w">
    </span><span class="kd">def</span><span class="w"> </span><span class="nf">record</span><span class="p" data-group-id="4272266914-4">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p" data-group-id="4272266914-4">)</span><span class="w">

    </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Convert to persistence object Options may be passed to coordinate actions like expanding embedded references. (With transaction wrapper if required)&quot;</span><span class="w">
    </span><span class="kd">def</span><span class="w"> </span><span class="nf">record!</span><span class="p" data-group-id="4272266914-5">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p" data-group-id="4272266914-5">)</span><span class="w">

    </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Convert to scaffolding.struct object. Options may be passed to coordinate actions like expanding embedded references.&quot;</span><span class="w">
    </span><span class="kd">def</span><span class="w"> </span><span class="nf">entity</span><span class="p" data-group-id="4272266914-6">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p" data-group-id="4272266914-6">)</span><span class="w">

    </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Convert to scaffolding.struct object Options may be passed to coordinate actions like expanding embedded references. (With transaction wrapper if required)&quot;</span><span class="w">
    </span><span class="kd">def</span><span class="w"> </span><span class="nf">entity!</span><span class="p" data-group-id="4272266914-7">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p" data-group-id="4272266914-7">)</span><span class="w">
  </span><span class="k" data-group-id="4272266914-1">end</span><span class="w"> </span><span class="c1"># end defprotocol Noizu.ERP</span></code></pre><p>Where the methods ref and sref convert any participating objects into {:ref, Module, id} and &quot;ref.module.id&quot; format respectively;  record and record! expand a reference into whatever format is used for db persistence (where options gives us a hook to dynamically adjust how records are converted to, for example, insert linked records if needed); and finally, where entity/2 and entity!/2 will insure our reference is in entity (struct) format.</p><p>It is up to the library user to provide the defimpls needed to handle sref format strings &quot;ref.type.identifier&quot;, along with defimpls for any structs and database classes used.
Additionally it is up to the library user to ensure that their struct classes implement the Noizu.AdvancedScaffolding.EntityBehaviour and that their structs and persistence records provide defimpls of the EntityReferenceProtocl to allow their conversion into ref, sref, record and entity format.</p><h2 id="auditengine" class="section-heading">
  <a href="#auditengine" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  AuditEngine
</h2>
<p>The Noizu.AdvancedScaffolding.RepoBehaviour will automatically make auditing calls as records are accessed and modified. This makes it very straight forward (provided an AuditEngine is defined) to generate robust audits of who has modified what and when.</p><p>A possible implementation may look like the following mnesia table and defimpl. Note how the mnesia table is setup to allow us to easily search by
entity, request token, time, or editor.</p><pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">YourProject.AuditEngine</span><span class="w"> </span><span class="k" data-group-id="3863734489-1">do</span><span class="w">
  </span><span class="na">@behaviour</span><span class="w"> </span><span class="nc">Noizu.AdvancedScaffolding.AudingEngineBehaviour</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">audit</span><span class="p" data-group-id="3863734489-2">(</span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">details</span><span class="p">,</span><span class="w"> </span><span class="n">entity</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">note</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="3863734489-2">)</span><span class="w"> </span><span class="k" data-group-id="3863734489-3">do</span><span class="w">  
    </span><span class="p" data-group-id="3863734489-4">%</span><span class="nc" data-group-id="3863734489-4">MnesiaDb.AuditHistory</span><span class="p" data-group-id="3863734489-4">{</span><span class="w">
      </span><span class="ss">entity</span><span class="p">:</span><span class="w"> </span><span class="nc">EntityReferenceProtocol</span><span class="o">.</span><span class="n">ref</span><span class="p" data-group-id="3863734489-5">(</span><span class="n">entity</span><span class="p" data-group-id="3863734489-5">)</span><span class="p">,</span><span class="w">
      </span><span class="ss">event</span><span class="p">:</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w">
      </span><span class="ss">details</span><span class="p">:</span><span class="w"> </span><span class="n">details</span><span class="p">,</span><span class="w">
      </span><span class="ss">time_stamp</span><span class="p">:</span><span class="w"> </span><span class="nc">DateTime</span><span class="o">.</span><span class="n">utc_now</span><span class="p" data-group-id="3863734489-6">(</span><span class="p" data-group-id="3863734489-6">)</span><span class="p">,</span><span class="w">
      </span><span class="ss">request_token</span><span class="p">:</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">token</span><span class="p">,</span><span class="w">
      </span><span class="ss">editor</span><span class="p">:</span><span class="w"> </span><span class="nc">EntityReferenceProtocol</span><span class="o">.</span><span class="n">ref</span><span class="p" data-group-id="3863734489-7">(</span><span class="n">context</span><span class="o">.</span><span class="n">caller</span><span class="p" data-group-id="3863734489-7">)</span><span class="p">,</span><span class="w">
      </span><span class="ss">reason</span><span class="p">:</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span><span class="w">
      </span><span class="ss">note</span><span class="p">:</span><span class="w"> </span><span class="n">note</span><span class="w">
    </span><span class="p" data-group-id="3863734489-4">}</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">MnesiaDb.AuditHistory</span><span class="o">.</span><span class="n">write</span><span class="w">
    </span><span class="ss">:ok</span><span class="w">
  </span><span class="k" data-group-id="3863734489-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">audit!</span><span class="p" data-group-id="3863734489-8">(</span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">details</span><span class="p">,</span><span class="w"> </span><span class="n">entity</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">note</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="3863734489-8">)</span><span class="w"> </span><span class="k" data-group-id="3863734489-9">do</span><span class="w">
    </span><span class="nc">Amnesia.Fragment</span><span class="o">.</span><span class="n">transaction</span><span class="w"> </span><span class="k" data-group-id="3863734489-10">do</span><span class="w">
      </span><span class="n">audit</span><span class="p" data-group-id="3863734489-11">(</span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">details</span><span class="p">,</span><span class="w"> </span><span class="n">entity</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">note</span><span class="p" data-group-id="3863734489-11">)</span><span class="w">
    </span><span class="k" data-group-id="3863734489-10">end</span><span class="w">
  </span><span class="k" data-group-id="3863734489-9">end</span><span class="w">
</span><span class="k" data-group-id="3863734489-1">end</span><span class="w">


</span><span class="c1">#-----------------------------------------------------------------------------</span><span class="w">
</span><span class="c1"># @AuditHistory</span><span class="w">
</span><span class="c1">#-----------------------------------------------------------------------------</span><span class="w">
</span><span class="n">deftable</span><span class="w"> </span><span class="nc">AuditHistory</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="3863734489-12">[</span><span class="ss">:entity</span><span class="p">,</span><span class="w"> </span><span class="ss">:event</span><span class="p">,</span><span class="w"> </span><span class="ss">:details</span><span class="p">,</span><span class="w"> </span><span class="ss">:time_stamp</span><span class="p">,</span><span class="w"> </span><span class="ss">:request_token</span><span class="p">,</span><span class="w"> </span><span class="ss">:editor</span><span class="p">,</span><span class="w"> </span><span class="ss">:reason</span><span class="p">,</span><span class="w"> </span><span class="ss">:note</span><span class="p" data-group-id="3863734489-12">]</span><span class="p">,</span><span class="w">
  </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:bag</span><span class="p">,</span><span class="w">
  </span><span class="ss">index</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3863734489-13">[</span><span class="ss">:request</span><span class="p">,</span><span class="w"> </span><span class="ss">:time_stamp</span><span class="p">,</span><span class="w"> </span><span class="ss">:editor</span><span class="p" data-group-id="3863734489-13">]</span><span class="p">,</span><span class="w">
  </span><span class="ss">fragmentation</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3863734489-14">[</span><span class="ss">number</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="ss">copying</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3863734489-15">%{</span><span class="ss">disk!</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="3863734489-15">}</span><span class="p" data-group-id="3863734489-14">]</span><span class="w"> </span><span class="k" data-group-id="3863734489-16">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Audit History - Basic structure for an Audit History Table
  &quot;&quot;&quot;</span><span class="w">
  </span><span class="na">@type</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p" data-group-id="3863734489-17">%</span><span class="nc" data-group-id="3863734489-17">AuditHistory</span><span class="p" data-group-id="3863734489-17">{</span><span class="w">
    </span><span class="ss">entity</span><span class="p">:</span><span class="w"> </span><span class="nc">Types</span><span class="o">.</span><span class="n">entity_reference</span><span class="p">,</span><span class="w"> </span><span class="c1"># The object being modified.</span><span class="w">
    </span><span class="ss">event</span><span class="p">:</span><span class="w"> </span><span class="n">atom</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tuple</span><span class="p">,</span><span class="w"> </span><span class="c1"># the event being audited, such as create table.</span><span class="w">
    </span><span class="ss">details</span><span class="p">:</span><span class="w"> </span><span class="n">any</span><span class="p">,</span><span class="w"> </span><span class="c1"># additional details about entry</span><span class="w">
    </span><span class="ss">time_stamp</span><span class="p">:</span><span class="w"> </span><span class="nc">DateTime</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="c1"># utc.now() of audit entry.</span><span class="w">
    </span><span class="ss">request_token</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="c1"># unique token that may be used to collate all audit logs related to a specific request.</span><span class="w">
    </span><span class="ss">editor</span><span class="p">:</span><span class="w"> </span><span class="nc">Types</span><span class="o">.</span><span class="n">entity_reference</span><span class="p">,</span><span class="w"> </span><span class="c1"># who made the change.</span><span class="w">
    </span><span class="ss">reason</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="c1"># calling.context reason (if any) provided when a call was made via api.</span><span class="w">
    </span><span class="ss">note</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="c1"># internal note about audit entry. Created when entry was created or added by a moderator later on.</span><span class="w">
  </span><span class="p" data-group-id="3863734489-17">}</span><span class="w">
</span><span class="k" data-group-id="3863734489-16">end</span><span class="w"> </span><span class="c1"># end deftable</span></code></pre><h2 id="calling-context" class="section-heading">
  <a href="#calling-context" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Calling Context
</h2>
<p>The Noizu.AdvancedScaffolding.CallingContext structure is used to pass information about API or related requests through out the system so that it is possible to confirm that a given caller is authorized to make changes, log who the caller was, apply global options to the request (such as expanding refs where found), and pass along a request token to allow admins to easily
collate requests across systems.</p><pre><code class="makeup elixir"><span class="na">@type</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p" data-group-id="2139429408-1">%</span><span class="nc" data-group-id="2139429408-1">CallingContext</span><span class="p" data-group-id="2139429408-1">{</span><span class="w">
  </span><span class="ss">caller</span><span class="p">:</span><span class="w"> </span><span class="n">tuple</span><span class="p">,</span><span class="w">
  </span><span class="ss">token</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="w">
  </span><span class="ss">reason</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="w">
  </span><span class="ss">auth</span><span class="p">:</span><span class="w"> </span><span class="nc">Any</span><span class="p">,</span><span class="w">
  </span><span class="ss">options</span><span class="p">:</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="w">
  </span><span class="ss">vsn</span><span class="p">:</span><span class="w"> </span><span class="n">float</span><span class="w">
</span><span class="p" data-group-id="2139429408-1">}</span></code></pre><p>It is left to the user to implement the logic needed to populate a CallingContext with these values. A sample implementation is below.</p><pre><code class="makeup elixir"><span class="w">  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Noizu.AdvancedScaffolding.CallingContext</span><span class="p">,</span><span class="w"> </span><span class="ss">as</span><span class="p">:</span><span class="w"> </span><span class="nc">CallingContext</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">default_get_context</span><span class="p" data-group-id="5673119682-1">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="5673119682-2">%{</span><span class="p" data-group-id="5673119682-2">}</span><span class="p" data-group-id="5673119682-1">)</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">default_get_context</span><span class="p" data-group-id="5673119682-3">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="c">_opts</span><span class="p" data-group-id="5673119682-3">)</span><span class="w"> </span><span class="k" data-group-id="5673119682-4">do</span><span class="w">
    </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="5673119682-5">[</span><span class="s">&quot;request-id&quot;</span><span class="p" data-group-id="5673119682-5">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="p" data-group-id="5673119682-6">(</span><span class="n">get_resp_header</span><span class="p" data-group-id="5673119682-7">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x-request-id&quot;</span><span class="p" data-group-id="5673119682-7">)</span><span class="p" data-group-id="5673119682-6">)</span><span class="w"> </span><span class="k" data-group-id="5673119682-8">do</span><span class="w">
      </span><span class="p" data-group-id="5673119682-9">[</span><span class="p" data-group-id="5673119682-9">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">CallingContext</span><span class="o">.</span><span class="n">generate_token</span><span class="p" data-group-id="5673119682-10">(</span><span class="p" data-group-id="5673119682-10">)</span><span class="w">
      </span><span class="p" data-group-id="5673119682-11">[</span><span class="n">h</span><span class="o">|</span><span class="c">_t</span><span class="p" data-group-id="5673119682-11">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">h</span><span class="w">
    </span><span class="k" data-group-id="5673119682-8">end</span><span class="w">
    </span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="5673119682-12">[</span><span class="s">&quot;call-reason&quot;</span><span class="p" data-group-id="5673119682-12">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="p" data-group-id="5673119682-13">(</span><span class="n">get_req_header</span><span class="p" data-group-id="5673119682-14">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x-call-reason&quot;</span><span class="p" data-group-id="5673119682-14">)</span><span class="p" data-group-id="5673119682-13">)</span><span class="w"> </span><span class="k" data-group-id="5673119682-15">do</span><span class="w">
      </span><span class="p" data-group-id="5673119682-16">[</span><span class="p" data-group-id="5673119682-16">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">nil</span><span class="w">
      </span><span class="p" data-group-id="5673119682-17">[</span><span class="n">h</span><span class="o">|</span><span class="c">_t</span><span class="p" data-group-id="5673119682-17">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">h</span><span class="w">
    </span><span class="k" data-group-id="5673119682-15">end</span><span class="w">

    </span><span class="n">expand_refs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="c1"># TODO - support ability for callers to request specific expansions.</span><span class="w">
    </span><span class="n">expand_all_refs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="5673119682-18">[</span><span class="s">&quot;expand-all-refs&quot;</span><span class="p" data-group-id="5673119682-18">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="k" data-group-id="5673119682-19">do</span><span class="w">
      </span><span class="no">true</span><span class="w">
    </span><span class="k" data-group-id="5673119682-19">else</span><span class="w">
      </span><span class="k">case</span><span class="w"> </span><span class="n">get_req_header</span><span class="p" data-group-id="5673119682-20">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x-expand-all-refs&quot;</span><span class="p" data-group-id="5673119682-20">)</span><span class="w"> </span><span class="k" data-group-id="5673119682-21">do</span><span class="w">
        </span><span class="p" data-group-id="5673119682-22">[</span><span class="p" data-group-id="5673119682-22">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">false</span><span class="w">
        </span><span class="p" data-group-id="5673119682-23">[</span><span class="n">h</span><span class="o">|</span><span class="c">_t</span><span class="p" data-group-id="5673119682-23">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w">
      </span><span class="k" data-group-id="5673119682-21">end</span><span class="w">
    </span><span class="k" data-group-id="5673119682-19">end</span><span class="w">

    </span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="5673119682-24">%{</span><span class="w">
      </span><span class="ss">expand_refs</span><span class="p">:</span><span class="w"> </span><span class="n">expand_refs</span><span class="p">,</span><span class="w">
      </span><span class="ss">expand_all_refs</span><span class="p">:</span><span class="w"> </span><span class="n">expand_all_refs</span><span class="w">
    </span><span class="p" data-group-id="5673119682-24">}</span><span class="w">

    </span><span class="k">case</span><span class="w"> </span><span class="nc">Guardian.Plug</span><span class="o">.</span><span class="n">current_resource</span><span class="p" data-group-id="5673119682-25">(</span><span class="n">conn</span><span class="p" data-group-id="5673119682-25">)</span><span class="w"> </span><span class="k" data-group-id="5673119682-26">do</span><span class="w">
      </span><span class="n">auth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="5673119682-27">%{</span><span class="s">&quot;identifier&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">user_identifier</span><span class="p" data-group-id="5673119682-27">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="5673119682-28">%</span><span class="nc" data-group-id="5673119682-28">CallingContext</span><span class="p" data-group-id="5673119682-28">{</span><span class="w">
          </span><span class="ss">caller</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5673119682-29">{</span><span class="ss">:ref</span><span class="p">,</span><span class="w"> </span><span class="n">user_identifier</span><span class="p">,</span><span class="w"> </span><span class="nc">SolaceBackend.Repos.UserRepo</span><span class="p" data-group-id="5673119682-29">}</span><span class="p">,</span><span class="w">
          </span><span class="ss">token</span><span class="p">:</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w">
          </span><span class="ss">reason</span><span class="p">:</span><span class="w"> </span><span class="n">reason</span><span class="p">,</span><span class="w">
          </span><span class="ss">auth</span><span class="p">:</span><span class="w"> </span><span class="n">auth</span><span class="p">,</span><span class="w">
          </span><span class="ss">options</span><span class="p">:</span><span class="w"> </span><span class="n">options</span><span class="w">
        </span><span class="p" data-group-id="5673119682-28">}</span><span class="w">
      </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="p" data-group-id="5673119682-30">%</span><span class="nc" data-group-id="5673119682-30">CallingContext</span><span class="p" data-group-id="5673119682-30">{</span><span class="w">
        </span><span class="ss">caller</span><span class="p">:</span><span class="w"> </span><span class="n">unauthenticated_ref</span><span class="p" data-group-id="5673119682-31">(</span><span class="n">conn</span><span class="p" data-group-id="5673119682-31">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">token</span><span class="p">:</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w">
        </span><span class="ss">reason</span><span class="p">:</span><span class="w"> </span><span class="n">reason</span><span class="p">,</span><span class="w">
        </span><span class="ss">auth</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w">
        </span><span class="ss">options</span><span class="p">:</span><span class="w"> </span><span class="n">options</span><span class="w">
      </span><span class="p" data-group-id="5673119682-30">}</span><span class="w">
    </span><span class="k" data-group-id="5673119682-26">end</span><span class="w">
  </span><span class="k" data-group-id="5673119682-4">end</span><span class="w"> </span><span class="c1"># end get_context/3</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">get_ip</span><span class="p" data-group-id="5673119682-32">(</span><span class="n">conn</span><span class="p" data-group-id="5673119682-32">)</span><span class="w"> </span><span class="k" data-group-id="5673119682-33">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Plug.Conn</span><span class="o">.</span><span class="n">get_req_header</span><span class="p" data-group-id="5673119682-34">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x-forwarded-for&quot;</span><span class="p" data-group-id="5673119682-34">)</span><span class="w"> </span><span class="k" data-group-id="5673119682-35">do</span><span class="w">
      </span><span class="p" data-group-id="5673119682-36">[</span><span class="n">h</span><span class="o">|</span><span class="bp">_</span><span class="p" data-group-id="5673119682-36">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">h</span><span class="w">
      </span><span class="p" data-group-id="5673119682-37">[</span><span class="p" data-group-id="5673119682-37">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">conn</span><span class="o">.</span><span class="n">remote_ip</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Tuple</span><span class="o">.</span><span class="n">to_list</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">join</span><span class="p" data-group-id="5673119682-38">(</span><span class="s">&quot;.&quot;</span><span class="p" data-group-id="5673119682-38">)</span><span class="w">
      </span><span class="no">nil</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">conn</span><span class="o">.</span><span class="n">remote_ip</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Tuple</span><span class="o">.</span><span class="n">to_list</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">join</span><span class="p" data-group-id="5673119682-39">(</span><span class="s">&quot;.&quot;</span><span class="p" data-group-id="5673119682-39">)</span><span class="w">
    </span><span class="k" data-group-id="5673119682-35">end</span><span class="w">
  </span><span class="k" data-group-id="5673119682-33">end</span><span class="w"> </span><span class="c1"># end get_ip/1</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">unauthenticated_ref</span><span class="p" data-group-id="5673119682-40">(</span><span class="n">conn</span><span class="p" data-group-id="5673119682-40">)</span><span class="w"> </span><span class="k" data-group-id="5673119682-41">do</span><span class="w">
   </span><span class="p" data-group-id="5673119682-42">{</span><span class="ss">:ref</span><span class="p">,</span><span class="w"> </span><span class="nc">System.UnauthenticatedUser</span><span class="p">,</span><span class="w"> </span><span class="n">get_ip</span><span class="p" data-group-id="5673119682-43">(</span><span class="n">conn</span><span class="p" data-group-id="5673119682-43">)</span><span class="p" data-group-id="5673119682-42">}</span><span class="w">
  </span><span class="k" data-group-id="5673119682-41">end</span><span class="w"> </span><span class="c1"># end unauthenticated_ref/1  </span></code></pre><h2 id="noizu-mnesia-identifiers-nmids" class="section-heading">
  <a href="#noizu-mnesia-identifiers-nmids" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Noizu Mnesia Identifiers (NMIDs)
</h2>
<p>AS an alternative to GUID based identifiers this library relies on noizu_mnesia_identifiers.
Each Entity/Table is assigned a unique identifier, as well as each node. 
Relying on these Repos provide a nmid_generator that produces sequential identifiers (per entity/table) with the final digits taken up with the server.node identifier + table/entity identifier. </p><pre><code class="makeup elixir"><span class="w">
</span><span class="kd">def</span><span class="w"> </span><span class="nf">generate</span><span class="p" data-group-id="5859720924-1">(</span><span class="n">seq</span><span class="p">,</span><span class="w"> </span><span class="c">_opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="5859720924-1">)</span><span class="w"> </span><span class="k" data-group-id="5859720924-2">do</span><span class="w">
  </span><span class="k">case</span><span class="w"> </span><span class="n">seq</span><span class="o">.</span><span class="c">__nmid__</span><span class="p" data-group-id="5859720924-3">(</span><span class="ss">:bare</span><span class="p" data-group-id="5859720924-3">)</span><span class="w"> </span><span class="k" data-group-id="5859720924-4">do</span><span class="w">
    </span><span class="no">true</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">bare</span><span class="p" data-group-id="5859720924-5">(</span><span class="n">seq</span><span class="p" data-group-id="5859720924-5">)</span><span class="w">
    </span><span class="ss">:node</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">bare_node</span><span class="p" data-group-id="5859720924-6">(</span><span class="n">seq</span><span class="p" data-group-id="5859720924-6">)</span><span class="w">
    </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:mnesia</span><span class="o">.</span><span class="n">dirty_update_counter</span><span class="p" data-group-id="5859720924-7">(</span><span class="nc">Noizu.AdvancedScaffolding.Database.NmidV3Generator.Table</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="5859720924-7">)</span><span class="w">
      </span><span class="n">map_id</span><span class="p" data-group-id="5859720924-8">(</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="na">@node_key</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="o">.</span><span class="c">__nmid__</span><span class="p" data-group-id="5859720924-9">(</span><span class="ss">:index</span><span class="p" data-group-id="5859720924-9">)</span><span class="p" data-group-id="5859720924-8">)</span><span class="w">
  </span><span class="k" data-group-id="5859720924-4">end</span><span class="w">
</span><span class="k" data-group-id="5859720924-2">end</span><span class="w">

</span><span class="kd">def</span><span class="w"> </span><span class="nf">map_id</span><span class="p" data-group-id="5859720924-10">(</span><span class="n">sequential_identifier</span><span class="p">,</span><span class="w"> </span><span class="n">node_key</span><span class="p">,</span><span class="w"> </span><span class="n">entity_key</span><span class="p" data-group-id="5859720924-10">)</span><span class="w"> </span><span class="k" data-group-id="5859720924-11">do</span><span class="w">
  </span><span class="n">sequential_identifier</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1_00_000</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p" data-group-id="5859720924-12">(</span><span class="n">rem</span><span class="p" data-group-id="5859720924-13">(</span><span class="n">node_key</span><span class="p">,</span><span class="w"> </span><span class="mi">99</span><span class="p" data-group-id="5859720924-13">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1_000</span><span class="p" data-group-id="5859720924-12">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rem</span><span class="p" data-group-id="5859720924-14">(</span><span class="n">entity_key</span><span class="p">,</span><span class="w"> </span><span class="mi">999</span><span class="p" data-group-id="5859720924-14">)</span><span class="w">
</span><span class="k" data-group-id="5859720924-11">end</span></code></pre>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="api-reference.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
API Reference
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="todo.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
TODO
        </span>
      </a>

  </div>
</div>

      <footer class="footer">

        <p>
          Find it on Hex:
          <a href="https://hex.pm/packages/noizu_advanced_scaffolding/1.2.23" class="line footer-hex-package">Package</a>
          <a href="https://preview.hex.pm/preview/noizu_advanced_scaffolding/1.2.23" class="line">Preview</a>

            <a href="https://preview.hex.pm/preview/noizu_advanced_scaffolding/1.2.23/show/README.md">(current file)</a>

        </p>

        <p>
          <span class="line">
            Built using
            <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener">ExDoc</a> (v0.25.5) for the
            <a href="https://elixir-lang.org" title="Elixir" target="_blank">Elixir programming language</a>.
          </span>
          <span class="line">
            Designed by
            <a href="https://twitter.com/dignifiedquire" target="_blank" rel="noopener" title="@dignifiedquire">Friedel Ziegelmayer</a>.
          </span>
        </p>
        <p>

            <a href="api-reference.html" title="API reference" class="line footer-button">API Reference</a>

          <button class="line footer-button display-shortcuts-help">
            Display keyboard shortcuts
          </button>
          <button class="line footer-button night-mode-toggle">
            Toggle night mode
          </button>
          <button class="line footer-button display-quick-switch">
            Go to a HexDocs package
          </button>
          <button class="line footer-button tooltips-toggle">
            <span class="tooltips-option-disable">Disable tooltips</span>
            <span class="tooltips-option-enable">Enable tooltips</span>
          </button>
        </p>
      </footer>
    </div>
  </div>
</section>
</div>


  </body>
</html>
