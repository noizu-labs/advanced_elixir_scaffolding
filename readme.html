<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.25.1">
    <meta name="project" content="Noizu.AdvancedScaffolding v1.0.1">

    <title>Noizu.AdvancedScaffolding — Noizu.AdvancedScaffolding v1.0.1</title>
    <link rel="stylesheet" href="dist/elixir-a172fe91e725dcb259e2.css" />

    <script src="dist/sidebar_items-67bcedf0f5.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/app-f27ff079945e43879c46.js"></script>


  </head>
  <body data-type="extras">
    <script>

      try {
        if (localStorage.getItem('night-mode') === 'true') {
          document.body.classList.add('night-mode');
        }
      } catch (error) { }
    </script>

<div class="main">

<button class="sidebar-button sidebar-toggle">
  <span class="icon-menu" title="Collapse/expand sidebar"></span>
</button>

<section class="sidebar">
  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <span class="icon-search" aria-hidden="true" title="Submit search"></span>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <span class="icon-cross" aria-hidden="true" title="Cancel search"></span>
    </button>
    <label class="search-label">
      <input name="q" type="text" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">
    <div class="sidebar-projectDetails">
      <a href="readme.html" class="sidebar-projectName">
Noizu.AdvancedScaffolding
      </a>
      <strong class="sidebar-projectVersion">
        v1.0.1
      </strong>
    </div>

  </div>

  <ul class="sidebar-listNav">
    <li><a id="extras-list-link" href="#full-list">Pages</a></li>

      <li><a id="modules-list-link" href="#full-list">Modules</a></li>


  </ul>
  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1>Noizu.AdvancedScaffolding</h1><p>This library provides some general tools to reduce some boiler plate code around working with objects, performing CRUD, auditing changes, performing basic authorization checks, and working with entity references (foreign keys). It includes various concepts previously applied to some of our private projects including blade of eternity, lacrosse alerts, and solace club.</p><h2 id="additional-documentation" class="section-heading">
  <a href="#additional-documentation" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Additional Documentation
</h2>
<ul><li><a href="http://noizu-labs.github.io/advanced_elixir_scaffolding">Api Documentation</a></li></ul><h1>New Features</h1><p>Advanced Scaffolding / Annotation / Indexing / Telemetry / Json Formatting / Security / PII management.</p><h2 id="see" class="section-heading">
  <a href="#see" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  See
</h2>
<ul><li><a href="Noizu.AdvancedScaffolding.Internal.Core.Entity.Behaviour.html"><code class="inline">Noizu.AdvancedScaffolding.Internal.Core.Entity.Behaviour</code></a></li><li><a href="Noizu.AdvancedScaffolding.Internal.Persistence.Entity.Behaviour.html"><code class="inline">Noizu.AdvancedScaffolding.Internal.Persistence.Entity.Behaviour</code></a></li><li><a href="Noizu.AdvancedScaffolding.Internal.EntityIndex.Entity.Behaviour.html"><code class="inline">Noizu.AdvancedScaffolding.Internal.EntityIndex.Entity.Behaviour</code></a></li><li><a href="Noizu.AdvancedScaffolding.Internal.Index.Behaviour.html"><code class="inline">Noizu.AdvancedScaffolding.Internal.Index.Behaviour</code></a></li><li><a href="Noizu.AdvancedScaffolding.Internal.Json.Entity.Behaviour.html"><code class="inline">Noizu.AdvancedScaffolding.Internal.Json.Entity.Behaviour</code></a></li></ul><h1>Json Formatting Annotation</h1><ul><li>Support for multiple json formatting view (mobile, admin, etc.)</li></ul><pre><code class="makeup elixir"><span class="w">
</span><span class="na">@json_format_group</span><span class="w"> </span><span class="p" data-group-id="8522697057-1">{</span><span class="ss">:user_clients</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8522697057-2">[</span><span class="ss">:compact</span><span class="p" data-group-id="8522697057-2">]</span><span class="p" data-group-id="8522697057-1">}</span><span class="w">
</span><span class="na">@json_provider</span><span class="w"> </span><span class="k">unquote</span><span class="p" data-group-id="8522697057-3">(</span><span class="n">json_provider</span><span class="p" data-group-id="8522697057-3">)</span><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Entity</span><span class="w"> </span><span class="k" data-group-id="8522697057-4">do</span><span class="w">
  </span><span class="nc">Noizu.DomainObject</span><span class="o">.</span><span class="n">noizu_entity</span><span class="w"> </span><span class="k" data-group-id="8522697057-5">do</span><span class="w">
    </span><span class="na">@meta</span><span class="w"> </span><span class="p" data-group-id="8522697057-6">{</span><span class="ss">:enum_entity</span><span class="p">,</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="8522697057-6">}</span><span class="w">
    </span><span class="n">identifier</span><span class="w"> </span><span class="ss">:integer</span><span class="w">
    </span><span class="na">@json</span><span class="w"> </span><span class="p" data-group-id="8522697057-7">{</span><span class="ss">:*</span><span class="p">,</span><span class="w"> </span><span class="ss">:expand</span><span class="p" data-group-id="8522697057-7">}</span><span class="w">
    </span><span class="na">@json_embed</span><span class="w"> </span><span class="p" data-group-id="8522697057-8">{</span><span class="ss">:user_clients</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8522697057-9">[</span><span class="p" data-group-id="8522697057-10">{</span><span class="ss">:title</span><span class="p">,</span><span class="w"> </span><span class="ss">as</span><span class="p">:</span><span class="w"> </span><span class="ss">:name</span><span class="p" data-group-id="8522697057-10">}</span><span class="p" data-group-id="8522697057-9">]</span><span class="p" data-group-id="8522697057-8">}</span><span class="w">
    </span><span class="na">@json_embed</span><span class="w"> </span><span class="p" data-group-id="8522697057-11">{</span><span class="ss">:verbose_mobile</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8522697057-12">[</span><span class="p" data-group-id="8522697057-13">{</span><span class="ss">:title</span><span class="p">,</span><span class="w"> </span><span class="ss">as</span><span class="p">:</span><span class="w"> </span><span class="ss">:name</span><span class="p" data-group-id="8522697057-13">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8522697057-14">{</span><span class="ss">:body</span><span class="p">,</span><span class="w"> </span><span class="ss">as</span><span class="p">:</span><span class="w"> </span><span class="ss">:description</span><span class="p" data-group-id="8522697057-14">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8522697057-15">{</span><span class="ss">:editor</span><span class="p">,</span><span class="w"> </span><span class="ss">sref</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="8522697057-15">}</span><span class="p">,</span><span class="w"> </span><span class="ss">:revision</span><span class="p" data-group-id="8522697057-12">]</span><span class="p" data-group-id="8522697057-11">}</span><span class="w">
    </span><span class="n">public_field</span><span class="w"> </span><span class="ss">:description</span><span class="p">,</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="nc">Noizu.VersionedString.Type</span><span class="w">

    </span><span class="na">@json</span><span class="w"> </span><span class="p" data-group-id="8522697057-16">{</span><span class="ss">:*</span><span class="p">,</span><span class="w"> </span><span class="ss">format</span><span class="p">:</span><span class="w"> </span><span class="ss">:iso8601</span><span class="p" data-group-id="8522697057-16">}</span><span class="w">
    </span><span class="na">@json_ignore</span><span class="w"> </span><span class="ss">:user_clients</span><span class="w">
    </span><span class="n">public_field</span><span class="w"> </span><span class="ss">:created_on</span><span class="p">,</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="nc">Noizu.DateTime.Type</span><span class="w">

    </span><span class="na">@json</span><span class="w"> </span><span class="p" data-group-id="8522697057-17">{</span><span class="ss">:*</span><span class="p">,</span><span class="w"> </span><span class="ss">format</span><span class="p">:</span><span class="w"> </span><span class="ss">:iso8601</span><span class="p" data-group-id="8522697057-17">}</span><span class="w">
    </span><span class="na">@json_ignore</span><span class="w"> </span><span class="p" data-group-id="8522697057-18">[</span><span class="ss">:user_clients</span><span class="p" data-group-id="8522697057-18">]</span><span class="w">
    </span><span class="n">public_field</span><span class="w"> </span><span class="ss">:modified_on</span><span class="p">,</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="nc">Noizu.DateTime.Type</span><span class="w">

    </span><span class="na">@json</span><span class="w"> </span><span class="p" data-group-id="8522697057-19">{</span><span class="ss">:*</span><span class="p">,</span><span class="w"> </span><span class="ss">format</span><span class="p">:</span><span class="w"> </span><span class="ss">:iso8601</span><span class="p" data-group-id="8522697057-19">}</span><span class="w">
    </span><span class="na">@json_ignore</span><span class="w"> </span><span class="p" data-group-id="8522697057-20">[</span><span class="ss">:user_clients</span><span class="p">,</span><span class="w"> </span><span class="ss">:verbose_mobile</span><span class="p" data-group-id="8522697057-20">]</span><span class="w">
    </span><span class="n">public_field</span><span class="w"> </span><span class="ss">:deleted_on</span><span class="p">,</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="nc">Noizu.DateTime.Type</span><span class="w">
  </span><span class="k" data-group-id="8522697057-5">end</span><span class="w">
</span><span class="k" data-group-id="8522697057-4">end</span><span class="w">
</span></code></pre><ul><li>Support for embedding nested components inside of entity. E.g. pull CMS record details and return inline as port of entity instead of as nested objects.</li></ul><pre><code class="makeup elixir"><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Entity</span><span class="w"> </span><span class="k" data-group-id="5345969193-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Noizu.DomainObject</span><span class="o">.</span><span class="n">noizu_entity</span><span class="p" data-group-id="5345969193-2">(</span><span class="p" data-group-id="5345969193-2">)</span><span class="w"> </span><span class="k" data-group-id="5345969193-3">do</span><span class="w">
    </span><span class="na">@json</span><span class="w"> </span><span class="err">{</span><span class="ss">:mobile</span><span class="p">,</span><span class="w"> </span><span class="ss">embed</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5345969193-4">[</span><span class="p" data-group-id="5345969193-5">{</span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="ss">as</span><span class="p">:</span><span class="w">  </span><span class="ss">:oh_hi</span><span class="p" data-group-id="5345969193-5">}</span><span class="p" data-group-id="5345969193-4">]</span><span class="w">
    </span><span class="n">public_field</span><span class="w"> </span><span class="ss">:description</span><span class="w">
  </span><span class="k" data-group-id="5345969193-3">end</span><span class="w">
</span><span class="k" data-group-id="5345969193-1">end</span><span class="w">

</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="5345969193-6">%</span><span class="nc" data-group-id="5345969193-6">Entity</span><span class="p" data-group-id="5345969193-6">{</span><span class="w">
    </span><span class="ss">description</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5345969193-7">%</span><span class="nc" data-group-id="5345969193-7">VersionedString</span><span class="p" data-group-id="5345969193-7">{</span><span class="ss">identifier</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="ss">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mark&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">created_on</span><span class="p">:</span><span class="w"> </span><span class="ss">:tuesday</span><span class="p" data-group-id="5345969193-7">}</span><span class="w">
</span><span class="p" data-group-id="5345969193-6">}</span><span class="w">


</span><span class="c1"># Poison.encode!(a, json_format: :mobile)</span><span class="w">
</span><span class="p" data-group-id="5345969193-8">{</span><span class="ss">identifier</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">oh_hi</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mark&quot;</span><span class="p" data-group-id="5345969193-8">}</span><span class="w">

</span><span class="c1"># Poison.encode!(a, json_format: :admin)</span><span class="w">
</span><span class="p" data-group-id="5345969193-9">{</span><span class="ss">identifier</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">description</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5345969193-10">%{</span><span class="ss">identifier</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="ss">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mark&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">created_on</span><span class="p">:</span><span class="w"> </span><span class="ss">:tuesday</span><span class="p" data-group-id="5345969193-10">}</span><span class="p" data-group-id="5345969193-9">}</span><span class="w">
</span></code></pre><h1>Content Permission Annotation and Fields</h1><ul><li>Flag fields that should only be accessible by administrators, owning user, or users owner has shared with with field types and annotation. Flag PII fields automatically suppress in log output by default.<pre><code class="makeup elixir"></code></pre></li></ul><p>defmodule Entity do</p><pre><code class="makeup elixir"><span class="na">@universal_identifier</span><span class="w"> </span><span class="no">true</span><span class="w">
</span><span class="nc">Noizu.DomainObject</span><span class="o">.</span><span class="n">noizu_entity</span><span class="w"> </span><span class="k" data-group-id="8192860447-1">do</span><span class="w">
</span><span class="na">@permissions</span><span class="w"> </span><span class="p" data-group-id="8192860447-2">{</span><span class="p" data-group-id="8192860447-3">[</span><span class="ss">:view</span><span class="p">,</span><span class="w"> </span><span class="ss">:index</span><span class="p" data-group-id="8192860447-3">]</span><span class="p">,</span><span class="w"> </span><span class="ss">:unrestricted</span><span class="p" data-group-id="8192860447-2">}</span><span class="w">
</span><span class="n">identifier</span><span class="w"> </span><span class="ss">:integer</span><span class="w">

 </span><span class="n">public_field</span><span class="w"> </span><span class="ss">:owner</span><span class="w">

 </span><span class="na">@json</span><span class="w"> </span><span class="p" data-group-id="8192860447-4">{</span><span class="ss">:*</span><span class="p">,</span><span class="w"> </span><span class="ss">:ignore</span><span class="p" data-group-id="8192860447-4">}</span><span class="w">  </span><span class="c1"># don&#39;t include this field by default in json response</span><span class="w">
 </span><span class="na">@json</span><span class="w"> </span><span class="p" data-group-id="8192860447-5">{</span><span class="ss">:admin_api</span><span class="p">,</span><span class="w"> </span><span class="ss">:include</span><span class="p" data-group-id="8192860447-5">}</span><span class="w"> </span><span class="c1"># except for admin_api formatted calls. </span><span class="w">
 </span><span class="n">public_field</span><span class="w"> </span><span class="ss">:last_login</span><span class="w">

  </span><span class="c1"># User (programmer) defined permission check - when attempting to access :bio check UserShare.has_permission? method to see if api caller has permission to view. </span><span class="w">
  </span><span class="na">@permissions</span><span class="w"> </span><span class="ss">:view</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8192860447-6">{</span><span class="ss">:restricted</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8192860447-7">{</span><span class="nc">UserShare</span><span class="p">,</span><span class="w"> </span><span class="ss">:has_permission?</span><span class="p" data-group-id="8192860447-7">}</span><span class="p" data-group-id="8192860447-6">}</span><span class="w">
  </span><span class="n">user_field</span><span class="w"> </span><span class="ss">:bio</span><span class="w">

  </span><span class="c1"># Only users with :account_moderator permission (granted by ACL - admin group membership} can edit/set   </span><span class="w">
  </span><span class="c1"># All callers can view the account_flag field. </span><span class="w">
  </span><span class="na">@permissions</span><span class="w"> </span><span class="p" data-group-id="8192860447-8">{</span><span class="ss">:*</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8192860447-9">{</span><span class="ss">:has_permission</span><span class="p">:</span><span class="w"> </span><span class="ss">:account_moderator</span><span class="p" data-group-id="8192860447-9">}</span><span class="p" data-group-id="8192860447-8">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8192860447-10">{</span><span class="ss">:view</span><span class="p">,</span><span class="w"> </span><span class="ss">:unrestricted</span><span class="p" data-group-id="8192860447-10">}</span><span class="w">
  </span><span class="na">@restricted_field</span><span class="w"> </span><span class="ss">:account_flag</span><span class="w"> 

  </span><span class="c1"># Only users who are members of the :system_account or :super_admin group may access.</span><span class="w">
  </span><span class="na">@permissions</span><span class="w"> </span><span class="p" data-group-id="8192860447-11">{</span><span class="ss">:*</span><span class="p">,</span><span class="w">  </span><span class="p" data-group-id="8192860447-12">[</span><span class="p" data-group-id="8192860447-13">{</span><span class="ss">:in_group</span><span class="p">:</span><span class="w"> </span><span class="ss">:system_account</span><span class="p" data-group-id="8192860447-13">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8192860447-14">{</span><span class="ss">:in_group</span><span class="p">:</span><span class="w"> </span><span class="ss">:super_admin</span><span class="p" data-group-id="8192860447-14">}</span><span class="p" data-group-id="8192860447-12">]</span><span class="p" data-group-id="8192860447-11">}</span><span class="w">
  </span><span class="na">@restricted_field</span><span class="w"> </span><span class="ss">:account_flag</span><span class="w"> 

 </span><span class="c1"># Low security (level 3) personally identifiable data. Can be included in most logs and exception messages.</span><span class="w">
  </span><span class="na">@pii</span><span class="w"> </span><span class="n">level_3</span><span class="w">
  </span><span class="n">restricted_field</span><span class="w"> </span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="nc">Noizu.VersionedName.Type</span><span class="w">

 </span><span class="c1"># High Security (level 0) PII. Only include in the most secure logs, strip from raised exceptions, etc.</span><span class="w">
  </span><span class="na">@pii</span><span class="w"> </span><span class="ss">:level_0</span><span class="w">
  </span><span class="n">restricted_field</span><span class="w"> </span><span class="ss">:social_security</span><span class="w">
</span><span class="k" data-group-id="8192860447-1">end</span></code></pre><p>end</p><h1>User (programmer) defined permission check. This example allows caller to view user.bio if the user</h1><h1>account is public or the caller is a friend with the user who the bio field belongs to.</h1><p>defmodule UserShare do</p><pre><code class="makeup elixir"><span class="c1"># the caller is a friend of the user, otherwise it restricts access and the bio field will not be returned to the caller.</span><span class="w">
</span><span class="kd">def</span><span class="w"> </span><span class="nf">has_permission?</span><span class="p" data-group-id="8661728378-1">(</span><span class="ss">:view</span><span class="p">,</span><span class="w"> </span><span class="ss">:bio</span><span class="p">,</span><span class="w"> </span><span class="n">entity</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p" data-group-id="8661728378-1">)</span><span class="w"> </span><span class="k" data-group-id="8661728378-2">do</span><span class="w">
  </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Noizu.ERP</span><span class="o">.</span><span class="n">entity!</span><span class="p" data-group-id="8661728378-3">(</span><span class="n">entity</span><span class="o">.</span><span class="n">owner</span><span class="p" data-group-id="8661728378-3">)</span><span class="w">
  </span><span class="k">cond</span><span class="w"> </span><span class="k" data-group-id="8661728378-4">do</span><span class="w">
    </span><span class="n">user</span><span class="o">.</span><span class="n">public_account?</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="ss">:permission_granted</span><span class="w">
    </span><span class="n">user</span><span class="o">.</span><span class="n">friend?</span><span class="p" data-group-id="8661728378-5">(</span><span class="n">context</span><span class="o">.</span><span class="n">caller</span><span class="p" data-group-id="8661728378-5">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="ss">:permission_granted</span><span class="w">
  </span><span class="ss">:else</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="ss">:permission_denied</span><span class="w">
  </span><span class="k" data-group-id="8661728378-4">end</span><span class="w">
</span><span class="k" data-group-id="8661728378-2">end</span></code></pre><p>end</p><pre><code class="makeup elixir"><span class="w">
</span><span class="c1"># Built in Multiple Datastore(s) + Cache management.</span><span class="w">

</span><span class="o">-</span><span class="w"> </span><span class="nc">Scaffolding</span><span class="w"> </span><span class="n">managing</span><span class="w"> </span><span class="n">keeping</span><span class="w"> </span><span class="n">different</span><span class="w"> </span><span class="n">datastores</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">cache</span><span class="w"> </span><span class="n">layers</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">date</span><span class="o">.</span><span class="w">
</span></code></pre><p>defmodule RootLevel.NestedLevel.Image do</p><pre><code class="makeup elixir"><span class="kn">use</span><span class="w"> </span><span class="nc">Noizu.DomainObject</span><span class="w">
</span><span class="na">@vsn</span><span class="w"> </span><span class="mf">1.0</span><span class="w">
</span><span class="na">@sref</span><span class="w"> </span><span class="s">&quot;image&quot;</span><span class="w">

</span><span class="c1"># Default Mnesia Database  (RootLevelSchema.Database) and table.  RootLevelSchema.Repo.database() &lt;&gt; &quot;NestedLevel.Image.Table&quot;</span><span class="w">
</span><span class="na">@persistence_layer</span><span class="w"> </span><span class="ss">:mnesia</span><span class="w">

</span><span class="c1"># Default Ecto Database/Repo (RootLevelSchema.Repo) and table.  RootLevelSchema.Repo.database() &lt;&gt; &quot;NestedLevel.Image.Table&quot;</span><span class="w">
</span><span class="na">@persistence_layer</span><span class="w"> </span><span class="p" data-group-id="4681933776-1">{</span><span class="ss">:ecto</span><span class="p">,</span><span class="w"> </span><span class="ss">cascade?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w"> </span><span class="ss">fallback_load</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="4681933776-1">}</span><span class="w">

</span><span class="c1"># Default Ecto Database with specific table, for example to allow lazy migration from a deprecated table</span><span class="w">
</span><span class="na">@persistence_layer</span><span class="w"> </span><span class="p" data-group-id="4681933776-2">{</span><span class="ss">:ecto</span><span class="p">,</span><span class="w"> </span><span class="ss">cascade?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p">,</span><span class="w"> </span><span class="ss">fallback_load</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w"> </span><span class="ss">table</span><span class="p">:</span><span class="w"> </span><span class="nc">NoizuSchema.MySQL.PreviousDatabaseTable</span><span class="p" data-group-id="4681933776-2">}</span><span class="w">

</span><span class="c1"># don&#39;t update/delete/create in legacy MSSQL database during crud operations. {cascade?: false}</span><span class="w">
</span><span class="c1"># allow load from mssql if entity not found in :mnesia or :ecto (MySQL)</span><span class="w">
</span><span class="na">@persistence_layer</span><span class="w"> </span><span class="p" data-group-id="4681933776-3">{</span><span class="nc">NoizuSchema.MSSQLRepo</span><span class="p">,</span><span class="w"> </span><span class="ss">cascade?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p">,</span><span class="w"> </span><span class="ss">fallback_load</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="4681933776-3">}</span><span class="w">


</span><span class="c1"># call archive provider on_delete hook when deleted entity, allows archive implementation to save entry to archive storage.</span><span class="w">
</span><span class="na">@persistence_layer</span><span class="w"> </span><span class="p" data-group-id="4681933776-4">{</span><span class="ss">:archive</span><span class="p">,</span><span class="w"> </span><span class="ss">cascade_delete?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="4681933776-4">}</span><span class="w"> </span><span class="c1"># call archive provider on_delete hook when deleted entity, allows archive implementation to save entry to archive storage.</span><span class="w">

</span><span class="c1"># Cache to redis and precache/update cascade one changes.</span><span class="w">
</span><span class="c1"># Don&#39;t return from Repo.create/update/delete until redis update complete (cascade_blocking: true),</span><span class="w">
</span><span class="c1"># automatic cache delete after 600 seconds. {ttl: 600}</span><span class="w">
</span><span class="na">@persistence_layer</span><span class="w"> </span><span class="p" data-group-id="4681933776-5">{</span><span class="ss">:redis</span><span class="p">,</span><span class="w"> </span><span class="ss">cascade?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w"> </span><span class="ss">cascade_blocking</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w"> </span><span class="ss">ttl</span><span class="p">:</span><span class="w"> </span><span class="mi">600</span><span class="p" data-group-id="4681933776-5">}</span><span class="w">


</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Entity</span><span class="w"> </span><span class="k" data-group-id="4681933776-6">do</span><span class="w">
  </span><span class="na">@universal_identifier</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="nc">Noizu.DomainObject</span><span class="o">.</span><span class="n">noizu_entity</span><span class="w"> </span><span class="k" data-group-id="4681933776-7">do</span><span class="w">
    </span><span class="n">identifier</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">ecto_identifier</span><span class="w"> </span><span class="ss">:integer</span><span class="w">
    </span><span class="n">public_fields</span><span class="w"> </span><span class="p" data-group-id="4681933776-8">[</span><span class="w">
    </span><span class="ss">:description</span><span class="p">,</span><span class="w">
    </span><span class="ss">:blur_hash</span><span class="p">,</span><span class="w">
    </span><span class="ss">:hash</span><span class="p">,</span><span class="w">
    </span><span class="ss">:base</span><span class="p">,</span><span class="w">
    </span><span class="ss">:source</span><span class="p">,</span><span class="w">
    </span><span class="ss">:base_dimensions</span><span class="p">,</span><span class="w">
    </span><span class="ss">:external</span><span class="p">,</span><span class="w">
    </span><span class="ss">:image_type</span><span class="p">,</span><span class="w">
    </span><span class="ss">:file_format</span><span class="p">,</span><span class="w">
    </span><span class="ss">:locale</span><span class="p">,</span><span class="w">
    </span><span class="ss">:localized</span><span class="p">,</span><span class="w">
    </span><span class="ss">:interactions</span><span class="p" data-group-id="4681933776-8">]</span><span class="w">
    </span><span class="n">public_fields</span><span class="w"> </span><span class="p" data-group-id="4681933776-9">[</span><span class="ss">:created_on</span><span class="p">,</span><span class="w"> </span><span class="ss">:modified_on</span><span class="p">,</span><span class="w"> </span><span class="ss">:deleted_on</span><span class="p" data-group-id="4681933776-9">]</span><span class="w">
  </span><span class="n">internal_fields</span><span class="w"> </span><span class="p" data-group-id="4681933776-10">[</span><span class="ss">:moderation_status</span><span class="p">,</span><span class="w"> </span><span class="ss">:content_flag</span><span class="p">,</span><span class="w"> </span><span class="ss">:sphinx_index</span><span class="p" data-group-id="4681933776-10">]</span><span class="w">
</span><span class="k" data-group-id="4681933776-7">end</span><span class="w">


</span><span class="kd">def</span><span class="w"> </span><span class="nf">__from_record__</span><span class="p" data-group-id="4681933776-11">(</span><span class="ss">:NoizuSchema</span><span class="o">.</span><span class="nc">MSSQLRepo</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4681933776-12">%</span><span class="nc" data-group-id="4681933776-12">NoizuSchema.MSSQL.NestedLevel.ImageTable</span><span class="p" data-group-id="4681933776-12">{</span><span class="p" data-group-id="4681933776-12">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p" data-group-id="4681933776-11">)</span><span class="w"> </span><span class="k" data-group-id="4681933776-13">do</span><span class="w">
  </span><span class="p">%</span><span class="bp">__MODULE__</span><span class="p" data-group-id="4681933776-14">{</span><span class="ss">custom_table_to_entity_provider</span><span class="p">:</span><span class="w"> </span><span class="n">record</span><span class="o">.</span><span class="n">field</span><span class="p" data-group-id="4681933776-14">}</span><span class="w">
</span><span class="k" data-group-id="4681933776-13">end</span><span class="w">
</span><span class="kd">def</span><span class="w"> </span><span class="nf">__from_record__</span><span class="p" data-group-id="4681933776-15">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p" data-group-id="4681933776-15">)</span><span class="w"> </span><span class="k" data-group-id="4681933776-16">do</span><span class="w">
  </span><span class="c1"># fallback to default providers. automatically injected by noizu_entity&#39;s before_compile method. </span><span class="w">
  </span><span class="k">super</span><span class="p" data-group-id="4681933776-17">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p" data-group-id="4681933776-17">)</span><span class="w">
</span><span class="k" data-group-id="4681933776-16">end</span></code></pre><p>  end
end</p><pre><code class="makeup elixir"><span class="w">
</span><span class="c1"># Sphinx Indexing Support</span><span class="w">

</span><span class="o">-</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="n">annotation</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">definitions</span><span class="w"> </span><span class="n">automate</span><span class="w"> </span><span class="n">search</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="n">population</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">formatting</span><span class="w">

</span></code></pre><h1>Automatically apply 5.2 km anonymization to location fields, always strip pii level 1 or lower</h1><h1>Automatically generate Noizu.#{Base}.Indexer module due to inline: :sphinx argument</h1><p>@index self: :sphinx, type: :realtime, [defaults: [{MyApp.Sphinx.LocationIndex, [anonymize: 5.2]}], pii: :level_2]</p><h1>include sensitive user data in index | runtime meta data scanning allows this index :admin_index to cover multiple entity types with out additional user configuration</h1><p>@index MyApp.Admin.Indexer, pii: :level_0</p><p>defmodule Entity do
  @universal_identifier true
  Noizu.DomainObject.noizu_entity do
  @permissions {[:view, :index], :unrestricted}
  identifier :integer</p><p>  @index true
  restricted_field :name, nil, MyApp.VersionedName.Type</p><p>  # Allow custom index controls, such as allowing users with private accounts to exclude their details from search. 
  @index {:user_defined, {MyApp.UserEntity, :index}}
  restricted_field :gender</p><p>  @index {MyApp.Admin.Indexer, as: :blob} # Include in multiple entity admin search index, embed field in json blob as admin index will not include entity specific fields like this.<br/>  @index {:inline, {:user_defined, {MyApp.UserEntity, :index}}}
  restricted_field :orientation</p><p>  # use MyAppIndex.Location handler to add  #{field}_longitude, #{field}_latitude, #{field}_zone, and #{field}_radius indexes for this field e.g. geo: %{longitude: 123.3, latitude: 432.0, radius: 5.2} 
  @index MyApp.Admin.Indexer: [with: MyAppIndex.Location]}
  @index inline: [with: {MyAppIndex.Location, anonymize: [radius: 25]}]  # Anonymize location to 25 radius bubble 
  restricted_field :geo</p><p>  @index true # Type Specification (MyAppSchema.Geo) will automatically trigger MyAppIndex.Location for unpacking -&gt; :home_town_longitude, :home_town_latitude, :home_town_radius ...
  restricted_field :home_town, nil, MyAppSchema.Geo</p><p>  # Todo
  defmodule Jety.Admin.Indexer do</p><pre><code class="makeup elixir"><span class="kn">use</span><span class="w"> </span><span class="nc">Noizu.DomainObject.Sphinx.Indexer</span><span class="w">
</span><span class="c1"># ...</span></code></pre><p>  end</p><pre><code class="makeup elixir"><span class="w">
</span><span class="c1"># Built in Logging/Telemetry</span><span class="w">

</span><span class="o">-</span><span class="w"> </span><span class="nc">Collate</span><span class="o">-</span><span class="n">able</span><span class="w"> </span><span class="n">logs</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">telemetrics</span><span class="w"> </span><span class="n">automatically</span><span class="w"> </span><span class="n">generated</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">entities</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">edited</span><span class="p">,</span><span class="w"> </span><span class="n">accessed</span><span class="p">,</span><span class="w"> </span><span class="n">cached</span><span class="p">,</span><span class="w"> </span><span class="n">etc</span><span class="o">.</span><span class="w">

</span><span class="o">-</span><span class="w"> </span><span class="nc">Unique</span><span class="w"> </span><span class="nc">Numeric</span><span class="w"> </span><span class="nc">Database</span><span class="w"> </span><span class="nc">Identifiers</span><span class="w">

</span><span class="o">-</span><span class="w"> </span><span class="nc">Table</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">Node</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="nc">Identifiers</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">universal</span><span class="w"> </span><span class="n">ids</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">specific</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="p" data-group-id="8943064162-1">(</span><span class="n">entity</span><span class="w"> </span><span class="n">encoded</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">identifiers</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">mimic</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">elixir</span><span class="w"> </span><span class="n">framework</span><span class="err">&#39;</span><span class="n">s</span><span class="w"> </span><span class="p" data-group-id="8943064162-2">{</span><span class="ss">:ref</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="8943064162-2">}</span><span class="w"> </span><span class="n">concept</span><span class="o">.</span><span class="w">  </span><span class="nc">Greatly</span><span class="w"> </span><span class="n">simplifies</span><span class="w"> </span><span class="n">sphinx</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="n">lookup</span><span class="p">,</span><span class="w"> </span><span class="n">provides</span><span class="w"> </span><span class="n">benefits</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="nc">GUIDs</span><span class="w"> </span><span class="n">while</span><span class="w"> </span><span class="n">retaining</span><span class="w"> </span><span class="n">much</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="n">matching</span><span class="o">.</span><span class="nc">Eventually</span><span class="w"> </span><span class="n">very</span><span class="w"> </span><span class="n">busy</span><span class="w"> </span><span class="n">tables</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">break</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="nc">UUIDs</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">approach</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">limits</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">universal</span><span class="w"> </span><span class="n">identifiers</span><span class="o">.</span><span class="w">
</span></code></pre><p>MyApp.User.Repo.generate_identifier!() -&gt;  1234005001 ,  where 1234 is User.Entity current incrementor value for this node, 005 is a unique identifier for a User.Entity/Table, and 001 is a node/server specific identifier.</p><h1>Scaffolding automatically injects UniversalIdentifierResolution{1234005001,  ref: {:ref, UserEntity, 1234005001}}} entry</h1><h1>If User was a univeral_lookup but not universal_identifier entity it's id would be 1234, while the universal identifier would reamain 1234005001 -&gt; UniversalIdentifierResolution{1234005001, ref: {:ref, User.Entity, 1234}}</h1><pre><code class="makeup elixir"><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="nc">Built</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">handling</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="nc">Atom</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="nc">Enum</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">switching</span><span class="w"> </span><span class="n">between</span><span class="w"> </span><span class="nc">RDMS</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">elixir</span><span class="o">.</span><span class="w">

</span><span class="o">-</span><span class="w"> </span><span class="nc">Look</span><span class="w"> </span><span class="nc">Up</span><span class="w"> </span><span class="nc">Entities</span><span class="w"> </span><span class="n">automatically</span><span class="w"> </span><span class="n">generate</span><span class="w"> </span><span class="nc">Ecto</span><span class="w"> </span><span class="n">types</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">avoid</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">manually</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">forth</span><span class="w"> </span><span class="n">between</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">enumerators</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">their</span><span class="w"> </span><span class="n">associated</span><span class="w"> </span><span class="n">elixir</span><span class="w"> </span><span class="n">atoms</span><span class="o">.</span><span class="nc">Thus</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="k" data-group-id="3150418914-1">do</span><span class="w"> </span><span class="n">something</span><span class="w"> </span><span class="n">like</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w">
</span></code></pre><p>schema &quot;table&quot; do</p><pre><code class="makeup elixir"><span class="n">field</span><span class="w"> </span><span class="ss">status</span><span class="p">:</span><span class="w">  </span><span class="nc">MyApp.Status.EctoEnumType</span></code></pre><p>end</p><p>defmodule MyApp.Status.Entity do</p><pre><code class="makeup elixir"><span class="nc">MyApp.ElixirScaffolding</span><span class="o">.</span><span class="n">enum_table</span><span class="p" data-group-id="2983722681-1">(</span><span class="p" data-group-id="2983722681-2">[</span><span class="ss">online</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">offline</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="2983722681-2">]</span><span class="p" data-group-id="2983722681-1">)</span></code></pre><p>end</p><p>%MySQL.Table{status: :online} |&gt; Repo.create()
t =Repo.get(MySQL.Table, identifier)
if t.status == :offline, do: stuff()</p><pre><code class="makeup elixir"><span class="w">
</span><span class="n">rather</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">much</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">verbose</span><span class="w"> </span><span class="n">equivalent</span><span class="w">
</span></code></pre><p>schema &quot;table&quot; do</p><pre><code class="makeup elixir"><span class="n">field</span><span class="w"> </span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="n">identifier</span></code></pre><p>end</p><p>defmodule MyApp.Status.Entity do</p><pre><code class="makeup elixir"><span class="n">...</span><span class="w">
</span><span class="na">@enum_to_atom</span><span class="w"> </span><span class="p" data-group-id="2464490541-1">%{</span><span class="w">
</span><span class="mi">0</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">:online</span><span class="p">,</span><span class="w">
</span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">:offline</span><span class="p">,</span><span class="w">
</span><span class="n">...</span><span class="w">
</span><span class="p" data-group-id="2464490541-1">}</span><span class="w">

</span><span class="na">@atom_to_enum</span><span class="w"> </span><span class="p" data-group-id="2464490541-2">%{</span><span class="w">
</span><span class="ss">online</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
</span><span class="ss">offline</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
</span><span class="n">...</span><span class="w">
</span><span class="p" data-group-id="2464490541-2">}</span><span class="w">

</span><span class="kd">def</span><span class="w"> </span><span class="nf">enum_to_atom</span><span class="p" data-group-id="2464490541-3">(</span><span class="n">v</span><span class="p" data-group-id="2464490541-3">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="na">@enum_to_atom</span><span class="p" data-group-id="2464490541-4">[</span><span class="n">v</span><span class="p" data-group-id="2464490541-4">]</span></code></pre><p>end</p><p>%MySQL.Table{status: MyApp.Status.Entity.atom_to_enum(:status)} |&gt; Repo.create()
t = Repo.get(MySQL.Table, identifier)
if MyApp.Status.Entity.enum_to_atom(t.status) == :offline, do: stuff()</p><pre><code class="makeup elixir"><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="nc">Reduce</span><span class="w"> </span><span class="nc">Lines</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="nc">Code</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nc">Maintenance</span><span class="o">*</span><span class="w">

</span><span class="o">-</span><span class="w"> </span><span class="nc">Scaffolding</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">Annotation</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="n">care</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">basic</span><span class="w"> </span><span class="nc">Json</span><span class="o">/</span><span class="nc">Database</span><span class="w"> </span><span class="nc">Crud</span><span class="w">

</span><span class="o">-</span><span class="w"> </span><span class="nc">Aspect</span><span class="o">-</span><span class="nc">Oriented</span><span class="o">-</span><span class="nc">Programming</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">annotation</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">macros</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">fine</span><span class="w"> </span><span class="n">tuned</span><span class="w"> </span><span class="n">extensions</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">customization</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">objects</span><span class="o">.</span><span class="w">

</span><span class="o">-</span><span class="w"> </span><span class="nc">Straight</span><span class="w"> </span><span class="n">forward</span><span class="w"> </span><span class="n">roll</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="n">wide</span><span class="w"> </span><span class="n">aop</span><span class="w"> </span><span class="n">behaviors</span><span class="o">/</span><span class="n">extensions</span><span class="o">.</span><span class="w">

</span><span class="nc">For</span><span class="w"> </span><span class="nc">Example</span><span class="w">
</span></code></pre><p>defmodule MyApp.Image.Type do</p><pre><code class="makeup elixir"><span class="na">@vsn</span><span class="w"> </span><span class="mf">1.0</span><span class="w">
</span><span class="na">@sref</span><span class="w"> </span><span class="s">&quot;image-type&quot;</span><span class="w">
</span><span class="kn">use</span><span class="w"> </span><span class="nc">MyApp.ElixirScaffolding.EnumEntity</span><span class="p">,</span><span class="w">
</span><span class="ss">values</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6864071395-1">[</span><span class="ss">none</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">profile</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">background</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">post</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="ss">user_upload</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="ss">logo</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="ss">moment</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="ss">shout_out</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="p" data-group-id="6864071395-1">]</span></code></pre><p>end</p><pre><code class="makeup elixir"><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="nc">Automatically</span><span class="w"> </span><span class="n">generates</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="nc">Image.Type.Entity</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="nc">Image.Type.Repo</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="nc">Image.Type.EctoEnumType</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="nc">Image.Type.EctoEnumReference</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="nc">MyApp.EnumEntity.Indexer</span><span class="w">  </span><span class="c1"># Search all entities or entities of a specific type to bring up matches for api text autocomplete</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="nc">Noizu.ERP</span><span class="o">.</span><span class="n">ref</span><span class="w"> </span><span class="n">handlers</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p" data-group-id="7445901278-1">(</span><span class="nc">Image.Type.Entity</span><span class="p">,</span><span class="w"> </span><span class="nc">Mysql.Image.Type.Table</span><span class="p">,</span><span class="w"> </span><span class="nc">Mnesia.Image.Type.Table</span><span class="p" data-group-id="7445901278-1">)</span><span class="w">

</span><span class="o">-</span><span class="w"> </span><span class="nc">Name</span><span class="o">/</span><span class="nc">Description</span><span class="w"> </span><span class="nc">Versioning</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="p" data-group-id="7445901278-2">(</span><span class="nc">Uses</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="nc">Noizu.VersionedString</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">provides</span><span class="w"> </span><span class="n">simple</span><span class="w"> </span><span class="n">revision</span><span class="w"> </span><span class="n">history</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">changes</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="n">title</span><span class="o">/</span><span class="n">description</span><span class="p" data-group-id="7445901278-2">)</span><span class="w">

</span><span class="o">-</span><span class="w"> </span><span class="nc">Runtime</span><span class="w"> </span><span class="nc">Noizu.ERP</span><span class="w"> </span><span class="n">ref</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">parser</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="s">&quot;ref.image-type.1234&quot;</span><span class="w"> </span><span class="n">formatted</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="n">strings</span><span class="o">.</span><span class="w">

</span><span class="c1"># Crud</span><span class="w">

</span><span class="nc">Json</span><span class="w"> </span><span class="n">formatting</span><span class="w"> </span><span class="p" data-group-id="7445901278-3">(</span><span class="k">for</span><span class="w"> </span><span class="n">mobile</span><span class="w"> </span><span class="n">view</span><span class="w"> </span><span class="n">collapse</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="p" data-group-id="7445901278-4">%</span><span class="nc" data-group-id="7445901278-4">MyApp.Image.Type</span><span class="p" data-group-id="7445901278-4">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">description</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7445901278-5">%{</span><span class="ss">title</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;User&quot;</span><span class="p" data-group-id="7445901278-5">}</span><span class="p" data-group-id="7445901278-4">}</span><span class="p" data-group-id="7445901278-3">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;User&quot;</span><span class="w">

</span><span class="nc">Data</span><span class="w"> </span><span class="n">setup</span><span class="w"> </span><span class="n">helpers</span><span class="o">.</span><span class="w">

</span><span class="ow">and</span><span class="w">  </span><span class="n">this</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="ow">in</span><span class="w">  </span><span class="n">jetzy</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jetzy_schema</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">enum_tables</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span></code></pre><p>require MyAppSchema.EnumTableBehaviour</p><h1>. . .</h1><p>MyAppSchema.EnumTableBehaviour.table(:image_type, Elixir.MyApp.Image.Type.Entity)</p><h1>. . .</h1><pre><code class="makeup elixir"><span class="w">
</span><span class="n">generates</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="nc">MyAppSchema.MySQL.Image.Type.Table</span><span class="w"> </span><span class="n">currently</span><span class="w"> </span><span class="n">equivalent</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w">
</span></code></pre><p>defmodule MyAppSchema.MySQL.Image.TypeTable do
@primary_key {:identifier, :id, autogenerate: false}
@derive {Phoenix.Param, key: :identifier}
schema &quot;image_type&quot; do
#field :description, MyApp.VersionedString.EctoUniversalReference</p><pre><code class="makeup elixir"><span class="w">      </span><span class="c1">#  Standard Time Stamps</span><span class="w">
      </span><span class="n">field</span><span class="w"> </span><span class="ss">:created_on</span><span class="p">,</span><span class="w"> </span><span class="ss">:utc_datetime_usec</span><span class="w">
      </span><span class="n">field</span><span class="w"> </span><span class="ss">:modified_on</span><span class="p">,</span><span class="w"> </span><span class="ss">:utc_datetime_usec</span><span class="w">
      </span><span class="n">field</span><span class="w"> </span><span class="ss">:deleted_on</span><span class="p">,</span><span class="w"> </span><span class="ss">:utc_datetime_usec</span><span class="w">
    </span><span class="k">end</span><span class="w">


  </span><span class="c1">#-------------------------------</span><span class="w">
  </span><span class="c1"># new</span><span class="w">
  </span><span class="c1">#-------------------------------</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">new</span><span class="p" data-group-id="8602122954-1">(</span><span class="n">options</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="8602122954-2">%{</span><span class="p" data-group-id="8602122954-2">}</span><span class="p" data-group-id="8602122954-1">)</span><span class="w"> </span><span class="k" data-group-id="8602122954-3">do</span><span class="w">
    </span><span class="n">struct</span><span class="p" data-group-id="8602122954-4">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p" data-group-id="8602122954-4">)</span><span class="w">
  </span><span class="k" data-group-id="8602122954-3">end</span><span class="w">

  </span><span class="c1">#-------------------------------</span><span class="w">
  </span><span class="c1"># changeset</span><span class="w">
  </span><span class="c1">#-------------------------------</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">changeset</span><span class="p" data-group-id="8602122954-5">(</span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="8602122954-5">)</span><span class="w"> </span><span class="k" data-group-id="8602122954-6">do</span><span class="w">
    </span><span class="n">fields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">keys</span><span class="p" data-group-id="8602122954-7">(</span><span class="n">record</span><span class="p" data-group-id="8602122954-7">)</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="p" data-group-id="8602122954-8">[</span><span class="ss">:__struct__</span><span class="p">,</span><span class="w"> </span><span class="ss">:__schema__</span><span class="p">,</span><span class="w"> </span><span class="ss">:__meta__</span><span class="p" data-group-id="8602122954-8">]</span><span class="w">
    </span><span class="n">record</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">cast</span><span class="p" data-group-id="8602122954-9">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">fields</span><span class="p" data-group-id="8602122954-9">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">validate_required</span><span class="p" data-group-id="8602122954-10">(</span><span class="p" data-group-id="8602122954-11">[</span><span class="p" data-group-id="8602122954-11">]</span><span class="p" data-group-id="8602122954-10">)</span><span class="w">
  </span><span class="k" data-group-id="8602122954-6">end</span><span class="w">



  </span><span class="kd">defdelegate</span><span class="w"> </span><span class="c">__entity__</span><span class="p" data-group-id="8602122954-12">(</span><span class="p" data-group-id="8602122954-12">)</span><span class="p">,</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="nc">MyApp.Image.Type.Entity</span><span class="w">
  </span><span class="kd">defdelegate</span><span class="w"> </span><span class="c">__repo__</span><span class="p" data-group-id="8602122954-13">(</span><span class="p" data-group-id="8602122954-13">)</span><span class="p">,</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="nc">MyApp.Image.Type.Entity</span><span class="w">
  </span><span class="kd">defdelegate</span><span class="w"> </span><span class="c">__sref__</span><span class="p" data-group-id="8602122954-14">(</span><span class="p" data-group-id="8602122954-14">)</span><span class="p">,</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="nc">MyApp.Image.Type.Entity</span><span class="w">
  </span><span class="kd">defdelegate</span><span class="w"> </span><span class="c">__erp__</span><span class="p" data-group-id="8602122954-15">(</span><span class="p" data-group-id="8602122954-15">)</span><span class="p">,</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="nc">MyApp.Image.Type.Entity</span><span class="w">

  </span><span class="kd">defdelegate</span><span class="w"> </span><span class="c">__persistence__</span><span class="p" data-group-id="8602122954-16">(</span><span class="n">setting</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="ss">:all</span><span class="p" data-group-id="8602122954-16">)</span><span class="p">,</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w">  </span><span class="nc">MyApp.Image.Type</span><span class="w">
  </span><span class="kd">defdelegate</span><span class="w"> </span><span class="c">__persistence__</span><span class="p" data-group-id="8602122954-17">(</span><span class="n">selector</span><span class="p">,</span><span class="w"> </span><span class="n">setting</span><span class="p" data-group-id="8602122954-17">)</span><span class="p">,</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w">  </span><span class="nc">MyApp.Image.Type</span><span class="w">
  </span><span class="kd">defdelegate</span><span class="w"> </span><span class="c">__nmid__</span><span class="p" data-group-id="8602122954-18">(</span><span class="n">setting</span><span class="p" data-group-id="8602122954-18">)</span><span class="p">,</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="nc">MyApp.Image.Type.Entity</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">__schema_table__</span><span class="p" data-group-id="8602122954-19">(</span><span class="p" data-group-id="8602122954-19">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="ss">:image_type</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">__noizu_info__</span><span class="p" data-group-id="8602122954-20">(</span><span class="ss">:type</span><span class="p" data-group-id="8602122954-20">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="ss">:enum_table</span><span class="w">
  </span><span class="kd">defdelegate</span><span class="w"> </span><span class="c">__noizu_info__</span><span class="p" data-group-id="8602122954-21">(</span><span class="n">setting</span><span class="p" data-group-id="8602122954-21">)</span><span class="p">,</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w">  </span><span class="nc">MyApp.Image.Type</span></code></pre><p>end</p><pre><code class="makeup elixir"><span class="w">
</span><span class="nc">Existing</span><span class="w">
</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">=</span><span class="w">


</span><span class="c1">## Refs</span><span class="w">
</span><span class="nc">Refs</span><span class="w"> </span><span class="n">provide</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">universal</span><span class="w"> </span><span class="n">way</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="n">records</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">external</span><span class="w"> </span><span class="n">entities</span><span class="o">.</span><span class="w"> </span><span class="nc">They</span><span class="w"> </span><span class="n">take</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">form</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">tuple</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="ss">follows</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4079035510-1">{</span><span class="ss">:ref</span><span class="p">,</span><span class="w"> </span><span class="nc">Entity.Module</span><span class="p">,</span><span class="w"> </span><span class="n">identifier</span><span class="p" data-group-id="4079035510-1">}</span><span class="w"> </span><span class="n">where</span><span class="w">
</span><span class="nc">Entity.Module</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">referencing</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">provides</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="n">entity</span><span class="p" data-group-id="4079035510-2">(</span><span class="n">nmid</span><span class="p" data-group-id="4079035510-2">)</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">capable</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">fetching</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="n">referenced</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">listed</span><span class="w"> </span><span class="n">identifier</span><span class="o">.</span><span class="w">

</span><span class="nc">This</span><span class="w"> </span><span class="n">makes</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">straight</span><span class="w"> </span><span class="n">forward</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="n">various</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="n">types</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">generic</span><span class="w"> </span><span class="n">way</span><span class="o">.</span><span class="w"> </span><span class="nc">Additionally</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nc">Noizu.ERP</span><span class="w"> </span><span class="p" data-group-id="4079035510-3">(</span><span class="nc">Entity</span><span class="w"> </span><span class="nc">Reference</span><span class="w"> </span><span class="nc">Protocol</span><span class="p" data-group-id="4079035510-3">)</span><span class="w"> </span><span class="n">provides</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">straight</span><span class="w"> </span><span class="n">forward</span><span class="w">
</span><span class="n">mechanism</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">handling</span><span class="w"> </span><span class="n">references</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">knowing</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">advance</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">expanded</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">their</span><span class="w"> </span><span class="n">exact</span><span class="w"> </span><span class="n">type</span><span class="o">.</span><span class="w">

</span><span class="nc">The</span><span class="w"> </span><span class="nc">EntityReferenceProtocol</span><span class="w"> </span><span class="p" data-group-id="4079035510-4">(</span><span class="kn">alias</span><span class="w"> </span><span class="nc">Noizu.ERP</span><span class="p">,</span><span class="w"> </span><span class="ss">as</span><span class="p">:</span><span class="w"> </span><span class="nc">EntityReferenceProtocol</span><span class="p" data-group-id="4079035510-4">)</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="ss">follows</span><span class="p">:</span><span class="w">
</span></code></pre><p>  defprotocol Noizu.ERP do</p><pre><code class="makeup elixir"><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Cast to noizu reference object&quot;</span><span class="w">
</span><span class="kd">def</span><span class="w"> </span><span class="nf">ref</span><span class="p" data-group-id="3934747831-1">(</span><span class="n">obj</span><span class="p" data-group-id="3934747831-1">)</span><span class="w">

</span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Cast to noizu string reference object&quot;</span><span class="w">
</span><span class="kd">def</span><span class="w"> </span><span class="nf">sref</span><span class="p" data-group-id="3934747831-2">(</span><span class="n">obj</span><span class="p" data-group-id="3934747831-2">)</span><span class="w">

</span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Convert to persistence object. Options may be passed to coordinate actions like expanding embedded references.&quot;</span><span class="w">
</span><span class="kd">def</span><span class="w"> </span><span class="nf">record</span><span class="p" data-group-id="3934747831-3">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p" data-group-id="3934747831-3">)</span><span class="w">

</span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Convert to persistence object Options may be passed to coordinate actions like expanding embedded references. (With transaction wrapper if required)&quot;</span><span class="w">
</span><span class="kd">def</span><span class="w"> </span><span class="nf">record!</span><span class="p" data-group-id="3934747831-4">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p" data-group-id="3934747831-4">)</span><span class="w">

</span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Convert to scaffolding.struct object. Options may be passed to coordinate actions like expanding embedded references.&quot;</span><span class="w">
</span><span class="kd">def</span><span class="w"> </span><span class="nf">entity</span><span class="p" data-group-id="3934747831-5">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p" data-group-id="3934747831-5">)</span><span class="w">

</span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Convert to scaffolding.struct object Options may be passed to coordinate actions like expanding embedded references. (With transaction wrapper if required)&quot;</span><span class="w">
</span><span class="kd">def</span><span class="w"> </span><span class="nf">entity!</span><span class="p" data-group-id="3934747831-6">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p" data-group-id="3934747831-6">)</span></code></pre><p>  end # end defprotocol Noizu.ERP</p><pre><code class="makeup elixir"><span class="w">
</span><span class="nc">Where</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">methods</span><span class="w"> </span><span class="n">ref</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">sref</span><span class="w"> </span><span class="n">convert</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">participating</span><span class="w"> </span><span class="n">objects</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="p" data-group-id="7775346122-1">{</span><span class="ss">:ref</span><span class="p">,</span><span class="w"> </span><span class="nc">Module</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="7775346122-1">}</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="s">&quot;ref.module.id&quot;</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">respectively</span><span class="p">;</span><span class="w">  </span><span class="n">record</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">record!</span><span class="w"> </span><span class="n">expand</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">whatever</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="n">persistence</span><span class="w"> </span><span class="p" data-group-id="7775346122-2">(</span><span class="n">where</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="n">gives</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">hook</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dynamically</span><span class="w"> </span><span class="n">adjust</span><span class="w"> </span><span class="n">how</span><span class="w"> </span><span class="n">records</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">converted</span><span class="w"> </span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">example</span><span class="p">,</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">linked</span><span class="w"> </span><span class="n">records</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">needed</span><span class="p" data-group-id="7775346122-2">)</span><span class="p">;</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">finally</span><span class="p">,</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">entity</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">entity!</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">insure</span><span class="w"> </span><span class="n">our</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="p" data-group-id="7775346122-3">(</span><span class="n">struct</span><span class="p" data-group-id="7775346122-3">)</span><span class="w"> </span><span class="n">format</span><span class="o">.</span><span class="w">

</span><span class="nc">It</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">provide</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">defimpls</span><span class="w"> </span><span class="n">needed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="n">sref</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="s">&quot;ref.type.identifier&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">along</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">defimpls</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">structs</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="n">classes</span><span class="w"> </span><span class="n">used</span><span class="o">.</span><span class="w">
</span><span class="nc">Additionally</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">ensure</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">their</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">classes</span><span class="w"> </span><span class="n">implement</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nc">Noizu.AdvancedScaffolding.EntityBehaviour</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">their</span><span class="w"> </span><span class="n">structs</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">persistence</span><span class="w"> </span><span class="n">records</span><span class="w"> </span><span class="n">provide</span><span class="w"> </span><span class="n">defimpls</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nc">EntityReferenceProtocl</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">their</span><span class="w"> </span><span class="n">conversion</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">ref</span><span class="p">,</span><span class="w"> </span><span class="n">sref</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="n">format</span><span class="o">.</span><span class="w">

</span><span class="c1">## AuditEngine</span><span class="w">

</span><span class="nc">The</span><span class="w"> </span><span class="nc">Noizu.AdvancedScaffolding.RepoBehaviour</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">automatically</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">auditing</span><span class="w"> </span><span class="n">calls</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">records</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">accessed</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">modified</span><span class="o">.</span><span class="w"> </span><span class="nc">This</span><span class="w"> </span><span class="n">makes</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">very</span><span class="w"> </span><span class="n">straight</span><span class="w"> </span><span class="n">forward</span><span class="w"> </span><span class="p" data-group-id="7775346122-4">(</span><span class="n">provided</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="nc">AuditEngine</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span><span class="p" data-group-id="7775346122-4">)</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">generate</span><span class="w"> </span><span class="n">robust</span><span class="w"> </span><span class="n">audits</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">who</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">modified</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">when</span><span class="o">.</span><span class="w">

</span><span class="nc">A</span><span class="w"> </span><span class="n">possible</span><span class="w"> </span><span class="n">implementation</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">look</span><span class="w"> </span><span class="n">like</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">mnesia</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="kd">defimpl</span><span class="o">.</span><span class="w"> </span><span class="nc">Note</span><span class="w"> </span><span class="n">how</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">mnesia</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">setup</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">easily</span><span class="w"> </span><span class="n">search</span><span class="w"> </span><span class="n">by</span><span class="w">
</span><span class="n">entity</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">editor</span><span class="o">.</span><span class="w">
</span></code></pre><p>defmodule YourProject.AuditEngine do
  @behaviour Noizu.AdvancedScaffolding.AudingEngineBehaviour</p><p>  def audit(event, details, entity, context, note \ nil) do  </p><pre><code class="makeup elixir"><span class="p" data-group-id="0309582885-1">%</span><span class="nc" data-group-id="0309582885-1">MnesiaDb.AuditHistory</span><span class="p" data-group-id="0309582885-1">{</span><span class="w">
  </span><span class="ss">entity</span><span class="p">:</span><span class="w"> </span><span class="nc">EntityReferenceProtocol</span><span class="o">.</span><span class="n">ref</span><span class="p" data-group-id="0309582885-2">(</span><span class="n">entity</span><span class="p" data-group-id="0309582885-2">)</span><span class="p">,</span><span class="w">
  </span><span class="ss">event</span><span class="p">:</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w">
  </span><span class="ss">details</span><span class="p">:</span><span class="w"> </span><span class="n">details</span><span class="p">,</span><span class="w">
  </span><span class="ss">time_stamp</span><span class="p">:</span><span class="w"> </span><span class="nc">DateTime</span><span class="o">.</span><span class="n">utc_now</span><span class="p" data-group-id="0309582885-3">(</span><span class="p" data-group-id="0309582885-3">)</span><span class="p">,</span><span class="w">
  </span><span class="ss">request_token</span><span class="p">:</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">token</span><span class="p">,</span><span class="w">
  </span><span class="ss">editor</span><span class="p">:</span><span class="w"> </span><span class="nc">EntityReferenceProtocol</span><span class="o">.</span><span class="n">ref</span><span class="p" data-group-id="0309582885-4">(</span><span class="n">context</span><span class="o">.</span><span class="n">caller</span><span class="p" data-group-id="0309582885-4">)</span><span class="p">,</span><span class="w">
  </span><span class="ss">reason</span><span class="p">:</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span><span class="w">
  </span><span class="ss">note</span><span class="p">:</span><span class="w"> </span><span class="n">note</span><span class="w">
</span><span class="p" data-group-id="0309582885-1">}</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">MnesiaDb.AuditHistory</span><span class="o">.</span><span class="n">write</span><span class="w">
</span><span class="ss">:ok</span></code></pre><p>  end</p><p>  def audit!(event, details, entity, context, note \ nil) do</p><pre><code class="makeup elixir"><span class="nc">Amnesia.Fragment</span><span class="o">.</span><span class="n">transaction</span><span class="w"> </span><span class="k" data-group-id="7964382684-1">do</span><span class="w">
  </span><span class="n">audit</span><span class="p" data-group-id="7964382684-2">(</span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">details</span><span class="p">,</span><span class="w"> </span><span class="n">entity</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">note</span><span class="p" data-group-id="7964382684-2">)</span><span class="w">
</span><span class="k" data-group-id="7964382684-1">end</span></code></pre><p>  end
end</p><p>#-----------------------------------------------------------------------------</p><h1>@AuditHistory</h1><p>#-----------------------------------------------------------------------------
deftable AuditHistory,
  [:entity, :event, :details, :time_stamp, :request_token, :editor, :reason, :note],
  type: :bag,
  index: [:request, :time_stamp, :editor],
  fragmentation: [number: 5, copying: %{disk!: 1}] do
  @moduledoc &quot;&quot;&quot;
  Audit History - Basic structure for an Audit History Table
  &quot;&quot;&quot;
  @type t :: %AuditHistory{</p><pre><code class="makeup elixir"><span class="ss">entity</span><span class="p">:</span><span class="w"> </span><span class="nc">Types</span><span class="o">.</span><span class="n">entity_reference</span><span class="p">,</span><span class="w"> </span><span class="c1"># The object being modified.</span><span class="w">
</span><span class="ss">event</span><span class="p">:</span><span class="w"> </span><span class="n">atom</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tuple</span><span class="p">,</span><span class="w"> </span><span class="c1"># the event being audited, such as create table.</span><span class="w">
</span><span class="ss">details</span><span class="p">:</span><span class="w"> </span><span class="n">any</span><span class="p">,</span><span class="w"> </span><span class="c1"># additional details about entry</span><span class="w">
</span><span class="ss">time_stamp</span><span class="p">:</span><span class="w"> </span><span class="nc">DateTime</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="c1"># utc.now() of audit entry.</span><span class="w">
</span><span class="ss">request_token</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="c1"># unique token that may be used to collate all audit logs related to a specific request.</span><span class="w">
</span><span class="ss">editor</span><span class="p">:</span><span class="w"> </span><span class="nc">Types</span><span class="o">.</span><span class="n">entity_reference</span><span class="p">,</span><span class="w"> </span><span class="c1"># who made the change.</span><span class="w">
</span><span class="ss">reason</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="c1"># calling.context reason (if any) provided when a call was made via api.</span><span class="w">
</span><span class="ss">note</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="c1"># internal note about audit entry. Created when entry was created or added by a moderator later on.</span></code></pre><p>  }
end # end deftable</p><pre><code class="makeup elixir"><span class="w">
</span><span class="c1">## Calling Context</span><span class="w">

</span><span class="nc">The</span><span class="w"> </span><span class="nc">Noizu.AdvancedScaffolding.CallingContext</span><span class="w"> </span><span class="n">structure</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">pass</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="nc">API</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">related</span><span class="w"> </span><span class="n">requests</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">possible</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">confirm</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">given</span><span class="w"> </span><span class="n">caller</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">authorized</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">changes</span><span class="p">,</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="n">who</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">caller</span><span class="w"> </span><span class="n">was</span><span class="p">,</span><span class="w"> </span><span class="n">apply</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="p" data-group-id="4594194637-1">(</span><span class="n">such</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">expanding</span><span class="w"> </span><span class="n">refs</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">found</span><span class="p" data-group-id="4594194637-1">)</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">pass</span><span class="w"> </span><span class="n">along</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">admins</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">easily</span><span class="w">
</span><span class="n">collate</span><span class="w"> </span><span class="n">requests</span><span class="w"> </span><span class="n">across</span><span class="w"> </span><span class="n">systems</span><span class="o">.</span><span class="w">
</span></code></pre><p>@type t :: %CallingContext{
  caller: tuple,
  token: String.t,
  reason: String.t,
  auth: Any,
  options: Map.t,
  vsn: float
}</p><pre><code class="makeup elixir"><span class="w">
</span><span class="nc">It</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">implement</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="n">needed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">populate</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="nc">CallingContext</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">these</span><span class="w"> </span><span class="n">values</span><span class="o">.</span><span class="w"> </span><span class="nc">A</span><span class="w"> </span><span class="n">sample</span><span class="w"> </span><span class="n">implementation</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">below</span><span class="o">.</span><span class="w">
</span></code></pre><p>  alias Noizu.AdvancedScaffolding.CallingContext, as: CallingContext
  def default_get_context(conn, params, opts \ %{})
  def default_get_context(conn, params, _opts) do</p><pre><code class="makeup elixir"><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="0415458551-1">[</span><span class="s">&quot;request-id&quot;</span><span class="p" data-group-id="0415458551-1">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="p" data-group-id="0415458551-2">(</span><span class="n">get_resp_header</span><span class="p" data-group-id="0415458551-3">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x-request-id&quot;</span><span class="p" data-group-id="0415458551-3">)</span><span class="p" data-group-id="0415458551-2">)</span><span class="w"> </span><span class="k" data-group-id="0415458551-4">do</span><span class="w">
  </span><span class="p" data-group-id="0415458551-5">[</span><span class="p" data-group-id="0415458551-5">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">CallingContext</span><span class="o">.</span><span class="n">generate_token</span><span class="p" data-group-id="0415458551-6">(</span><span class="p" data-group-id="0415458551-6">)</span><span class="w">
  </span><span class="p" data-group-id="0415458551-7">[</span><span class="n">h</span><span class="o">|</span><span class="c">_t</span><span class="p" data-group-id="0415458551-7">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">h</span><span class="w">
</span><span class="k" data-group-id="0415458551-4">end</span><span class="w">
</span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="0415458551-8">[</span><span class="s">&quot;call-reason&quot;</span><span class="p" data-group-id="0415458551-8">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="p" data-group-id="0415458551-9">(</span><span class="n">get_req_header</span><span class="p" data-group-id="0415458551-10">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x-call-reason&quot;</span><span class="p" data-group-id="0415458551-10">)</span><span class="p" data-group-id="0415458551-9">)</span><span class="w"> </span><span class="k" data-group-id="0415458551-11">do</span><span class="w">
  </span><span class="p" data-group-id="0415458551-12">[</span><span class="p" data-group-id="0415458551-12">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">nil</span><span class="w">
  </span><span class="p" data-group-id="0415458551-13">[</span><span class="n">h</span><span class="o">|</span><span class="c">_t</span><span class="p" data-group-id="0415458551-13">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">h</span><span class="w">
</span><span class="k" data-group-id="0415458551-11">end</span><span class="w">

</span><span class="n">expand_refs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="c1"># TODO - support ability for callers to request specific expansions.</span><span class="w">
</span><span class="n">expand_all_refs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="0415458551-14">[</span><span class="s">&quot;expand-all-refs&quot;</span><span class="p" data-group-id="0415458551-14">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="k" data-group-id="0415458551-15">do</span><span class="w">
  </span><span class="no">true</span><span class="w">
</span><span class="k" data-group-id="0415458551-15">else</span><span class="w">
  </span><span class="k">case</span><span class="w"> </span><span class="n">get_req_header</span><span class="p" data-group-id="0415458551-16">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x-expand-all-refs&quot;</span><span class="p" data-group-id="0415458551-16">)</span><span class="w"> </span><span class="k" data-group-id="0415458551-17">do</span><span class="w">
    </span><span class="p" data-group-id="0415458551-18">[</span><span class="p" data-group-id="0415458551-18">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">false</span><span class="w">
    </span><span class="p" data-group-id="0415458551-19">[</span><span class="n">h</span><span class="o">|</span><span class="c">_t</span><span class="p" data-group-id="0415458551-19">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w">
  </span><span class="k" data-group-id="0415458551-17">end</span><span class="w">
</span><span class="k" data-group-id="0415458551-15">end</span><span class="w">

</span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="0415458551-20">%{</span><span class="w">
  </span><span class="ss">expand_refs</span><span class="p">:</span><span class="w"> </span><span class="n">expand_refs</span><span class="p">,</span><span class="w">
  </span><span class="ss">expand_all_refs</span><span class="p">:</span><span class="w"> </span><span class="n">expand_all_refs</span><span class="w">
</span><span class="p" data-group-id="0415458551-20">}</span><span class="w">

</span><span class="k">case</span><span class="w"> </span><span class="nc">Guardian.Plug</span><span class="o">.</span><span class="n">current_resource</span><span class="p" data-group-id="0415458551-21">(</span><span class="n">conn</span><span class="p" data-group-id="0415458551-21">)</span><span class="w"> </span><span class="k" data-group-id="0415458551-22">do</span><span class="w">
  </span><span class="n">auth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="0415458551-23">%{</span><span class="s">&quot;identifier&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">user_identifier</span><span class="p" data-group-id="0415458551-23">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="0415458551-24">%</span><span class="nc" data-group-id="0415458551-24">CallingContext</span><span class="p" data-group-id="0415458551-24">{</span><span class="w">
      </span><span class="ss">caller</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0415458551-25">{</span><span class="ss">:ref</span><span class="p">,</span><span class="w"> </span><span class="n">user_identifier</span><span class="p">,</span><span class="w"> </span><span class="nc">SolaceBackend.Repos.UserRepo</span><span class="p" data-group-id="0415458551-25">}</span><span class="p">,</span><span class="w">
      </span><span class="ss">token</span><span class="p">:</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w">
      </span><span class="ss">reason</span><span class="p">:</span><span class="w"> </span><span class="n">reason</span><span class="p">,</span><span class="w">
      </span><span class="ss">auth</span><span class="p">:</span><span class="w"> </span><span class="n">auth</span><span class="p">,</span><span class="w">
      </span><span class="ss">options</span><span class="p">:</span><span class="w"> </span><span class="n">options</span><span class="w">
    </span><span class="p" data-group-id="0415458551-24">}</span><span class="w">
  </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="p" data-group-id="0415458551-26">%</span><span class="nc" data-group-id="0415458551-26">CallingContext</span><span class="p" data-group-id="0415458551-26">{</span><span class="w">
    </span><span class="ss">caller</span><span class="p">:</span><span class="w"> </span><span class="n">unauthenticated_ref</span><span class="p" data-group-id="0415458551-27">(</span><span class="n">conn</span><span class="p" data-group-id="0415458551-27">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">token</span><span class="p">:</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w">
    </span><span class="ss">reason</span><span class="p">:</span><span class="w"> </span><span class="n">reason</span><span class="p">,</span><span class="w">
    </span><span class="ss">auth</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w">
    </span><span class="ss">options</span><span class="p">:</span><span class="w"> </span><span class="n">options</span><span class="w">
  </span><span class="p" data-group-id="0415458551-26">}</span><span class="w">
</span><span class="k" data-group-id="0415458551-22">end</span></code></pre><p>  end # end get_context/3</p><p>  def get_ip(conn) do</p><pre><code class="makeup elixir"><span class="k">case</span><span class="w"> </span><span class="nc">Plug.Conn</span><span class="o">.</span><span class="n">get_req_header</span><span class="p" data-group-id="4255815654-1">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x-forwarded-for&quot;</span><span class="p" data-group-id="4255815654-1">)</span><span class="w"> </span><span class="k" data-group-id="4255815654-2">do</span><span class="w">
  </span><span class="p" data-group-id="4255815654-3">[</span><span class="n">h</span><span class="o">|</span><span class="bp">_</span><span class="p" data-group-id="4255815654-3">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">h</span><span class="w">
  </span><span class="p" data-group-id="4255815654-4">[</span><span class="p" data-group-id="4255815654-4">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">conn</span><span class="o">.</span><span class="n">remote_ip</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Tuple</span><span class="o">.</span><span class="n">to_list</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">join</span><span class="p" data-group-id="4255815654-5">(</span><span class="s">&quot;.&quot;</span><span class="p" data-group-id="4255815654-5">)</span><span class="w">
  </span><span class="no">nil</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">conn</span><span class="o">.</span><span class="n">remote_ip</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Tuple</span><span class="o">.</span><span class="n">to_list</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">join</span><span class="p" data-group-id="4255815654-6">(</span><span class="s">&quot;.&quot;</span><span class="p" data-group-id="4255815654-6">)</span><span class="w">
</span><span class="k" data-group-id="4255815654-2">end</span></code></pre><p>  end # end get_ip/1</p><p>  def unauthenticated_ref(conn) do</p><p>  end # end unauthenticated_ref/1  </p><pre><code class="makeup elixir"><span class="w">
</span><span class="c1">## Noizu Mnesia Identifiers (NMIDs)</span><span class="w">
</span><span class="nc">AS</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">alternative</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="nc">GUID</span><span class="w"> </span><span class="n">based</span><span class="w"> </span><span class="n">identifiers</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="n">relies</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">noizu_mnesia_identifiers</span><span class="o">.</span><span class="w">
</span><span class="nc">Each</span><span class="w"> </span><span class="nc">Entity</span><span class="o">/</span><span class="nc">Table</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">assigned</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">unique</span><span class="w"> </span><span class="n">identifier</span><span class="p">,</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">well</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="n">node</span><span class="o">.</span><span class="w"> 
</span><span class="nc">Relying</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">these</span><span class="w"> </span><span class="nc">Repos</span><span class="w"> </span><span class="n">provide</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">nmid_generator</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">produces</span><span class="w"> </span><span class="n">sequential</span><span class="w"> </span><span class="n">identifiers</span><span class="w"> </span><span class="p" data-group-id="5580172726-1">(</span><span class="n">per</span><span class="w"> </span><span class="n">entity</span><span class="o">/</span><span class="n">table</span><span class="p" data-group-id="5580172726-1">)</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">final</span><span class="w"> </span><span class="n">digits</span><span class="w"> </span><span class="n">taken</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">server</span><span class="o">.</span><span class="n">node</span><span class="w"> </span><span class="n">identifier</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">table</span><span class="o">/</span><span class="n">entity</span><span class="w"> </span><span class="n">identifier</span><span class="o">.</span><span class="w"> 
</span></code></pre><p>def generate(seq, <em>opts \ nil) do
  case seq.<em>_nmid</em></em>(:bare) do</p><pre><code class="makeup elixir"><span class="no">true</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">bare</span><span class="p" data-group-id="7912391128-1">(</span><span class="n">seq</span><span class="p" data-group-id="7912391128-1">)</span><span class="w">
</span><span class="ss">:node</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">bare_node</span><span class="p" data-group-id="7912391128-2">(</span><span class="n">seq</span><span class="p" data-group-id="7912391128-2">)</span><span class="w">
</span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">:mnesia</span><span class="o">.</span><span class="n">dirty_update_counter</span><span class="p" data-group-id="7912391128-3">(</span><span class="nc">Noizu.AdvancedScaffolding.Database.NmidV3Generator.Table</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="7912391128-3">)</span><span class="w">
  </span><span class="n">map_id</span><span class="p" data-group-id="7912391128-4">(</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="na">@node_key</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="o">.</span><span class="c">__nmid__</span><span class="p" data-group-id="7912391128-5">(</span><span class="ss">:index</span><span class="p" data-group-id="7912391128-5">)</span><span class="p" data-group-id="7912391128-4">)</span></code></pre><p>  end
end</p><p>def map_id(sequential_identifier, node_key, entity_key) do
  sequential_identifier <em> 1_00_000 + (rem(node_key, 99) </em> 1_000) + rem(entity_key, 999)
end</p><pre><code class="makeup elixir"></code></pre>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="api-reference.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
API Reference
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="todo.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
TODO
        </span>
      </a>

  </div>
</div>

      <footer class="footer">
        <p>
          <span class="line">
            Built using
            <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener">ExDoc</a> (v0.25.1) for the
            <a href="https://elixir-lang.org" title="Elixir" target="_blank">Elixir programming language</a>.
          </span>
          <span class="line">
            Designed by
            <a href="https://twitter.com/dignifiedquire" target="_blank" rel="noopener" title="@dignifiedquire">Friedel Ziegelmayer</a>.
          </span>
        </p>
        <p>

            <a href="api-reference.html" title="API reference" class="line footer-button">API Reference</a>

          <button class="line footer-button display-shortcuts-help">
            Display keyboard shortcuts
          </button>
          <button class="line footer-button night-mode-toggle">
            Toggle night mode
          </button>
          <button class="line footer-button display-quick-switch">
            Go to a HexDocs package
          </button>
          <button class="line footer-button tooltips-toggle">
            <span class="tooltips-option-disable">Disable tooltips</span>
            <span class="tooltips-option-enable">Enable tooltips</span>
          </button>
        </p>
      </footer>
    </div>
  </div>
</section>
</div>


  </body>
</html>
